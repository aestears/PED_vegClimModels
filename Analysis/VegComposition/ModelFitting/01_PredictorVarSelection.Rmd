---
title: "Selecting Climate, Weather, and Soils variables"
subtitle: "These variables will serve as predictors in models of vegetation functional composition"
author: "Alice Stears"
date: "`r lubridate::today()`"
params: 
  test_run: FALSE
save_figs: FALSE
output:
  html_document:
  toc: true
toc_float:
  collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE,
                      message = FALSE)
library(here)
library(tidyverse)
library(kableExtra)
library(GGally) 
```

```{r read in Data and load functions, include = FALSE}

my_fn <- function(data, mapping, method="p", use="pairwise", ...){
  
  # grab data
  x <- eval_data_col(data, mapping$x)
  y <- eval_data_col(data, mapping$y)
  
  # calculate correlation
  corr <- cor(x, y, method=method, use=use)
  
  # calculate colour based on correlation value
  # Here I have set a correlation of minus one to blue, 
  # zero to white, and one to red 
  # Change this to suit: possibly extend to add as an argument of `my_fn`
  colFn <- colorRampPalette(c("red", "white", "blue"), interpolate ='spline')
  fill <- colFn(100)[findInterval(corr, seq(-1, 1, length=100))]
  
  ggally_cor(data = data, mapping = mapping, size = 2.5, stars = FALSE, 
             digits = 2, colour = I("black"),...) + 
    theme_void() +
    theme(panel.background = element_rect(fill=fill))
  
}


here::i_am("Analysis/VegComposition/ModelFitting/01_PredictorVarSelection.Rmd")
# use dataset that includes yes/no tree predictions, which we'll use to idenitfy uncorrelated predictors for tree vs no tree areas
dat <- readRDS( here("Data_processed", "CoverData", "CoverModelData_withTreeNoTreePreds.rds"))
```

## Background

The **weather** and **climate** variables used in this analysis are calculated from DayMet. Information about vegetation functional composition from FIA, AIM, and the LANDFIRE reference database is averaged to the same spatial scale as dayMet, so the dataset we use contains climate and weather information for every dayMet cell that has vegetation functional composition information in each year when that vegetation data were collected. 

For each dayMet grid cell in each year when vegetation data was collected, we calculated the following set of climate variables (average values over the previous years (as few as 5 and as many as 30 years)) and weather variable anomalies (the average of values over the previous 3 years relative to the climate average). Note that the we indicate the method of summarizing a climate variable across the climate or weather anomaly years, as well as the units and the method that the recent weather anomaly relative to the climate variable was calculated.  

```{r, echo = FALSE, results = 'asis'}

knitr::kable(format = "html", data.frame("Variable" = 
                          c("Average annual minimum daily temperature - Mean across years" ,                     
                            "Average annual maximum daily temperature - Mean across years", 
                            "Average annual mean daily temperature - Mean across years",             
                            "Total annual daily precipitation - Mean across years" ,     
                            "Temperature of the warmest month - Mean across years"        , 
                            "Temperature of the coldest month - Mean across years"       ,     
                            "Precipitation of wettest month - Mean across years"   , 
                            "Precipitation of driest month - Mean across years"   ,     
                            "Precipitation seasonality - Mean across years"    , 
                            "Correlation of monthly precipitation and temperature - Mean across years"       ,     
                            "Month when temperature first is above freezing - Mean across years"   , 
                            "Isothermality - Mean across years"        ,     
                            "Annual Water Deficit - Mean across years"       , 
                            "Annual wet degree days - Mean across years"        ,     
                            "Anual mean vapor pressure deficit - Mean across years", 
                            "Annual maximum vapor pressure deficit- Mean across years" ,     
                            "Annual minimum vapor pressure deficit- Mean across years" , 
                            "Number of of frost-free days - Mean across years",
                            "Annual maximum vapor pressure deficit - 95th percentile across years" ,     
                            "Annual water deficit - 95th percentile across years" , 
                            "Annual wet degree days - 5th percentile across years"       ,     
                            "Number of of frost-free days - 5th percentile across years"),
             "Units" = 
               c("Degrees Celsius", 
                 "Degrees Celsius",
                 "Degrees Celsius", 
                 "mm",
                 "Degrees Celsius",
                 "Degrees Celsius",
                 "mm",
                 "mm",
                 "mm",
                 "correlation", 
                 "numerical month",
                 "isothermal ratio",
                 "mm of water/degrees celsius",
                 "Degree days",
                 "milibars",
                 "milibars", 
                 "milibars", 
                 "days", 
                 "milibars", 
                 "mm of water/degrees celsius", 
                 "Degree days", 
                 "days"
                 ), 
             "Anomaly_Format" = 
               c("absolute difference", 
                 "absolute difference", 
                 "absolute difference", 
                 "% difference", 
                 "absolute difference", 
                 "absolute difference",
                 "% difference", 
                 "% difference", 
                 "% difference", 
                 "absolute difference",
                 "absolute difference",
                 "absolute difference", 
                 "% difference", 
                 "% difference", 
                 "absolute difference",
                 "absolute difference",
                 "absolute difference",
                 "absolute difference",
                 "absolute difference",
                 "% difference",
                 "% difference",
                 "absolute difference")
)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```

Now, look at the distribution of input values
```{r}
dat %>% 
  select(tmin:frostFreeDays_anom, Year, x, y) %>% 
  pivot_longer(cols = tmin:frostFreeDays_anom,
               names_to = "variable",
               values_to = "value"
                ) %>% 
  ggplot() +
  facet_wrap(~variable, scales = "free") +
   geom_histogram(aes(value))

```

For each grid cell, we also include **soil** information, which is extrapolated from the SOLUS100 dataset. This information is fixed across time in our dataset. 
```{r, echo = FALSE, results = 'asis'}

knitr::kable(format = "html", data.frame("Variable" = 
                          c("soil depth" ,                     
                            "percentage of clay in the soil surface (0-3 cm)",
                            "average percentage of sand across the soil profile",
                            "average percentage of coarse fragments across the soil profile",
                            "percentage of organic matter in the soil surface (0-3 cm)",
                            "total available water holding capacity"
))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```

## Identify un-correlated climate and soils predictors -- uniquely for each ecoregion 

First, we want to identify a set of possible climate and soils predictors that are not correlated to then use as predictors in models that estimate vegetation composition. 

We do this first for all of CONUS, then independently for each of two ecoregions (shrub/grassland and forest)

### CONUS 
```{r, echo = FALSE, include = FALSE}
## drop observations so we don't have any NAs
datCONUS <- dat %>% 
   select(tmin:frostFreeDays_anom,
         soilDepth:AWHC, treeProb_bestLambda_binary) %>% 
  drop_na()  
```

```{r, fig.width= 18, fig.height = 16}
#Here is the correlation structure of all of the potential input climate and soils variables
(corrPlot <- 
   datCONUS %>% 
      dplyr::select(
       "tmin", 
      "tmax", 
      "tmean",
      "prcp",
      "t_warm",
      "t_cold",
      "prcp_wet",
      "prcp_dry",
      "prcp_seasonality",
      "prcpTempCorr",
      "abvFreezingMonth",
      "isothermality",
      "annWatDef",
      "annWetDegDays",
      "VPD_mean",
      "VPD_max",
      "VPD_min",
      "VPD_max_95",
      "annWatDef_95",
      "annWetDegDays_5",
      "frostFreeDays_5",
      "frostFreeDays",
      "soilDepth",
      "clay",
      "sand",
      "coarse",
      "carbon",
      "AWHC"
   ) %>% 
    slice_sample(n = 5e3) %>% 
   #cor()  %>% 
   #caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) 
   ggpairs(upper = list(continuous = my_fn
                          ,  size = .1
                        ), 
     lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=.1
                                            )), 
            progress = FALSE) )# + ggtitle("Correlation of Grass/Shrubland Predictor Variables"))

# corrPlot
# dev.off()
```
The following variables were removed due to correlation with other variables -- first pass (vars. in parenthesis are kept):

* tmin, tmax, t_warm, t_cold (tmean)
* precip_wet (prcp)
* frostfreedays, frostfree days_5, abvfreezingmonth (tmean)
* VPD mean, VPD min, VPD max 95 (VPD_max)
* soildepth (AWHC)

```{r, echo = FALSE, fig.width=14, fig.height=13}
(corrPlot <- 
   datCONUS %>% 
   dplyr::select(
      #"tmin", 
      #"tmax", 
      "tmean",
      "prcp",
      #"t_warm",
      #"t_cold",
      #"prcp_wet",
      "prcp_dry",
      "prcp_seasonality",
      "prcpTempCorr",
      #"abvFreezingMonth",
      "isothermality",
      "annWatDef",
      "annWetDegDays",
      #"VPD_mean",
      "VPD_max",
      #"VPD_min",
      #"VPD_max_95",
      "annWatDef_95",
      "annWetDegDays_5",
      #"frostFreeDays_5",
      #"frostFreeDays",
      #"soilDepth",
      "clay",
      "sand",
      "coarse",
      "carbon",
      "AWHC"
   ) %>%
    slice_sample(n = 5e4) %>% 
   #cor()  %>% 
   #caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) %>% 
     ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1
                                                                                                  )), progress = FALSE))

# bmp( here("Figures", "CoverDatFigures", "GrassShrubClimVarCorrelations_v2.bmp"), width = 2500, height = 2500)
# corrPlot
# dev.off()
```

Then, we removed the following additional variables based on their correlation: 

```{r, echo = FALSE}
 (corrPlot <- 
   datCONUS %>% 
   dplyr::select(
       #"tmin", 
      #"tmax", 
      "tmean", #1
      "prcp", #2
      #"t_warm",
      #"t_cold",
      #"prcp_wet",
      #"prcp_dry", 
      "prcp_seasonality", #3
      "prcpTempCorr", #4
      #"abvFreezingMonth",
      "isothermality", #5
      #"annWatDef",
      "annWetDegDays", #6 
      #"VPD_mean",
      #"VPD_max", 
      #"VPD_min",
      #"VPD_max_95",
      #"annWatDef_95", 
      #"annWetDegDays_5", 
      #"frostFreeDays_5",
      #"frostFreeDays",
      #"soilDepth",
      #"clay", #7
      "sand", #8
      "coarse", #9
      #"carbon", #10
      "AWHC" #11
   ) %>%
    #slice_sample(n = 5e4) %>% 
   cor()  %>% 
   caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) 
     #ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1)), progress = FALSE))

```

* 'annWetDegDays_5' and 'annWetDegDays': cor =  .98; chose 'annWetDegDays'
* 'annWatDef_95' and 'annWatDef': cor =  .98; chose 'annWatDef'
* 'annWatDef' and 'prcp_seasonality': cor =  .78; chose 'prcp_seasonality' 
* 'prcp_dry' and 'prcp_seasonality': cor =  .79; chose 'prcp_seasonality' 
* 'tmean' and 'VPD_max': cor =  .93; chose 'tmean' (opposite of recommendation by function, but tmean is easier to calculate)
* 'sand' and 'clay': cor =  .70; chose 'sand'
# remove Carbon, since it's highly skewed 

The final variables selected are shown below
```{r, echo = FALSE, fig.width= 9, fig.width = 8}
 (corrPlot <- 
   datCONUS %>% 
   dplyr::select(
        #"tmin", 
      #"tmax", 
      "tmean", #1
      "prcp", #2
      #"t_warm",
      #"t_cold",
      #"prcp_wet",
      #"prcp_dry", 
      "prcp_seasonality", #3
      "prcpTempCorr", #4
      #"abvFreezingMonth",
      "isothermality", #5
      #"annWatDef",
      "annWetDegDays", #6 
      #"VPD_mean",
      #"VPD_max", 
      #"VPD_min",
      #"VPD_max_95",
      #"annWatDef_95", 
      #"annWetDegDays_5", 
      #"frostFreeDays_5",
      #"frostFreeDays",
      #"soilDepth",
      #"clay", #7
      "sand", #8
      "coarse", #9
      #"carbon", #10
      "AWHC" #11
   ) %>%
    slice_sample(n = 5e4) %>% 
   # cor()  %>% 
   # caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) 
     ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1
                                                                                                  )), progress = FALSE))

conusClimVars <- c(    #"tmin", 
      #"tmax", 
      "tmean", #1
      "prcp", #2
      #"t_warm",
      #"t_cold",
      #"prcp_wet",
      #"prcp_dry", 
      "prcp_seasonality", #3
      "prcpTempCorr", #4
      #"abvFreezingMonth",
      "isothermality", #5
      #"annWatDef",
      "annWetDegDays", #6 
      #"VPD_mean",
      #"VPD_max", 
      #"VPD_min",
      #"VPD_max_95",
      #"annWatDef_95", 
      #"annWetDegDays_5", 
      #"frostFreeDays_5",
      #"frostFreeDays",
      #"soilDepth",
      #"clay", #7
      "sand", #8
      "coarse", #9
      #"carbon", #10
      "AWHC" #11
      )
```


### CONUS - higher threshold for allowed correlation 
We allow higher correlation between potential predictors in this version, since LASSO is more robust to correlated predictors. 
In this case we use a correlation of .8 as the cutoff for excluding predictors for the list. 
```{r, echo = FALSE, include = FALSE}
## drop observations so we don't have any NAs
datCONUS2 <- datCONUS
```

```{r, fig.width= 18, fig.height = 16}
#Here is the correlation structure of all of the potential input climate and soils variables
(corrPlot <- 
   datCONUS2 %>% 
      dplyr::select(
       "tmin", 
      "tmax", 
      "tmean",
      "prcp",
      "t_warm",
      "t_cold",
      "prcp_wet",
      "prcp_dry",
      "prcp_seasonality",
      "prcpTempCorr",
      "abvFreezingMonth",
      "isothermality",
      "annWatDef",
      "annWetDegDays",
      "VPD_mean",
      "VPD_max",
      "VPD_min",
      "VPD_max_95",
      "annWatDef_95",
      "annWetDegDays_5",
      "frostFreeDays_5",
      "frostFreeDays",
      "soilDepth",
      "clay",
      "sand",
      "coarse",
      "carbon",
      "AWHC"
   ) %>% 
    slice_sample(n = 5e3) %>% 
   #cor()  %>% 
   #caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) 
   ggpairs(upper = list(continuous = my_fn
                          ,  size = .1
                        ), 
     lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=.1
                                            )), 
            progress = FALSE) )# + ggtitle("Correlation of Grass/Shrubland Predictor Variables"))

# corrPlot
# dev.off()
```
The following variables were removed due to correlation with other variables -- first pass (vars. in parenthesis are kept):

* tmin, tmax, t_warm, t_cold (tmean)
* precip_wet (prcp)
* frostfreedays, frostfree days_5, abvfreezingmonth (tmean)
* VPD mean, VPD min, VPD max 95 (VPD_max)
* soildepth (AWHC)

```{r, echo = FALSE, fig.width=14, fig.height=13}
(corrPlot <- 
   datCONUS2 %>% 
   dplyr::select(
      #"tmin", 
      #"tmax", 
      "tmean",
      "prcp",
      #"t_warm",
      #"t_cold",
      #"prcp_wet",
      "prcp_dry",
      "prcp_seasonality",
      "prcpTempCorr",
      #"abvFreezingMonth",
      "isothermality",
      "annWatDef",
      "annWetDegDays",
      #"VPD_mean",
      "VPD_max",
      #"VPD_min",
      #"VPD_max_95",
      "annWatDef_95",
      "annWetDegDays_5",
      #"frostFreeDays_5",
      #"frostFreeDays",
      #"soilDepth",
      "clay",
      "sand",
      "coarse",
      "carbon",
      "AWHC"
   ) %>%
    slice_sample(n = 5e4) %>% 
   #cor()  %>% 
   #caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) %>% 
     ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1
                                                                                                  )), progress = FALSE))

# bmp( here("Figures", "CoverDatFigures", "GrassShrubClimVarCorrelations_v2.bmp"), width = 2500, height = 2500)
# corrPlot
# dev.off()
```

Then, we removed the following additional variables based on their correlation: 

```{r, echo = FALSE}
 (corrPlot <- 
   datCONUS2 %>% 
   dplyr::select(
      #"tmin", 
      #"tmax", 
      "tmean",
      "prcp", #1
      #"t_warm",
      #"t_cold",
      #"prcp_wet",
      "prcp_dry", #2
      "prcp_seasonality", #3 
      "prcpTempCorr", #4
      #"abvFreezingMonth",
      "isothermality", #5
      #"annWatDef", 
      "annWetDegDays", #6
      #"VPD_mean",
      #"VPD_max", #7
      #"VPD_min",
      #"VPD_max_95",
      "annWatDef_95", #8
      #"annWetDegDays_5", 
      #"frostFreeDays_5",
      #"frostFreeDays",
      #"soilDepth",
      "clay", #9
      #"sand", #10
      "coarse", #11
      #"carbon", #12
      "AWHC" #13
   ) %>%
    #slice_sample(n = 5e4) %>% 
   cor()  %>% 
   caret::findCorrelation(cutoff = .8, verbose = TRUE, names = TRUE, exact = TRUE)) 
     #ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1)), progress = FALSE))

```
Compare annWatDef  and annWatDef_95 with corr  0.983; chose annWatDef_95
Compare annWetDegDays_5  and annWetDegDays with corr  0.951; chose annWetDegDays
Compare VPD_max  and tmean with corr  0.929; chose tmean (against function suggestion, but easier to calculate)
Compare sand and clay with corr  0.802; chose clay
remove Carbon, since it's highly skewed


The final variables selected are shown below
```{r, echo = FALSE, fig.width= 9, fig.width = 8}
 (corrPlot <- 
     datCONUS2 %>% 
   dplyr::select(
      #"tmin", 
      #"tmax", 
      "tmean",
      "prcp", #1
      #"t_warm",
      #"t_cold",
      #"prcp_wet",
      "prcp_dry", #2
      "prcp_seasonality", #3 
      "prcpTempCorr", #4
      #"abvFreezingMonth",
      "isothermality", #5
      #"annWatDef", 
      "annWetDegDays", #6
      #"VPD_mean",
      #"VPD_max", #7
      #"VPD_min",
      #"VPD_max_95",
      "annWatDef_95", #8
      #"annWetDegDays_5", 
      #"frostFreeDays_5",
      #"frostFreeDays",
      #"soilDepth",
      "clay", #9
      #"sand", #10
      "coarse", #11
      #"carbon", #12
      "AWHC" #13
   ) %>%
    slice_sample(n = 5e4) %>% 
   # cor()  %>% 
   # caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) 
     ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1
                                                                                                  )), progress = FALSE))

conusClimVars2 <- c(      #"tmin", 
        #"tmin", 
      #"tmax", 
      "tmean",
      "prcp", #1
      #"t_warm",
      #"t_cold",
      #"prcp_wet",
      "prcp_dry", #2
      "prcp_seasonality", #3 
      "prcpTempCorr", #4
      #"abvFreezingMonth",
      "isothermality", #5
      #"annWatDef", 
      "annWetDegDays", #6
      #"VPD_mean",
      #"VPD_max", #7
      #"VPD_min",
      #"VPD_max_95",
      "annWatDef_95", #8
      #"annWetDegDays_5", 
      #"frostFreeDays_5",
      #"frostFreeDays",
      #"soilDepth",
      "clay", #9
      #"sand", #10
      "coarse", #11
      #"carbon", #12
      "AWHC" #13
      )
```

### Un-treed areas

First, get data just for un-treed sites (based on classification from the bestLambda model) (and drop NAs )
```{r, echo = FALSE, include = FALSE}
## drop observations so we don't have any NAs
datGrassShrub <-  dat %>% 
   select(tmin:frostFreeDays_anom,
         soilDepth:AWHC, treeProb_bestLambda_binary) %>% 
  drop_na()  %>% 
  filter(treeProb_bestLambda_binary ==0)
  
```

```{r, fig.width= 18, fig.height = 16}
#Here is the correlation structure of all of the potential input climate and soils variables
(corrPlot <- 
   datGrassShrub %>% 
      dplyr::select(
       "tmin", 
      "tmax", 
      "tmean",
      "prcp",
      "t_warm",
      "t_cold",
      "prcp_wet",
      "prcp_dry",
      "prcp_seasonality",
      "prcpTempCorr",
      "abvFreezingMonth",
      "isothermality",
      "annWatDef",
      "annWetDegDays",
      "VPD_mean",
      "VPD_max",
      "VPD_min",
      "VPD_max_95",
      "annWatDef_95",
      "annWetDegDays_5",
      "frostFreeDays_5",
      "frostFreeDays",
      "soilDepth",
      "clay",
      "sand",
      "coarse",
      "carbon",
      "AWHC"
   ) %>% 
    slice_sample(n = 5e3) %>% 
   #cor()  %>% 
   #caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) 
   ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=.1
                                                                                                )), progress = FALSE) #+ ggtitle("Correlation of Grass/Shrubland Predictor Variables")
 )
# bmp( here("Figures", "CoverDatFigures", "GrassShrubClimVarCorrelations.bmp"), width = 2500, height = 2500)
# corrPlot
# dev.off()
```

The following variables were removed due to correlation with other variables -- first pass (vars. in parenthesis are kept):

* tmin, tmax, t_warm, t_cold (tmean)
* precip_wet (prcp)
* frostfreedays, frostfree days_5, abvfreezingmonth (tmean)
* VPD mean, VPD min, VPD max 95 (VPD_max)
* soildepth (AWHC)

```{r, echo = FALSE, fig.width=14, fig.height=13}
(corrPlot <- 
   datGrassShrub %>% 
   dplyr::select(
      #"tmin", 
      #"tmax", 
      "tmean",
      "prcp",
      #"t_warm",
      #"t_cold",
      #"prcp_wet",
      "prcp_dry",
      "prcp_seasonality",
      "prcpTempCorr",
      #"abvFreezingMonth",
      "isothermality",
      "annWatDef",
      "annWetDegDays",
      #"VPD_mean",
      "VPD_max",
      #"VPD_min",
      #"VPD_max_95",
      "annWatDef_95",
      "annWetDegDays_5",
      #"frostFreeDays_5",
      #"frostFreeDays",
      #"soilDepth",
      "clay",
      "sand",
      "coarse",
      "carbon",
      "AWHC"
   ) %>%
    slice_sample(n = 5e4) %>% 
   #cor()  %>% 
   #caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) %>% 
     ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1
                                                                                                  )), progress = FALSE))

# bmp( here("Figures", "CoverDatFigures", "GrassShrubClimVarCorrelations_v2.bmp"), width = 2500, height = 2500)
# corrPlot
# dev.off()
```

Then, we removed the following additional variables based on their correlation: 

```{r, echo = FALSE}
 (corrPlot <- 
   datGrassShrub %>% 
   dplyr::select(
       #"tmin", 
      #"tmax", 
      "tmean", #1
      "prcp", #2
      #"t_warm",
      #"t_cold",
      #"prcp_wet",
      "prcp_dry", #3
      "prcp_seasonality", #4
      "prcpTempCorr", #5
      #"abvFreezingMonth",
      "isothermality", #6
      #"annWatDef",
      #"annWetDegDays", 
      #"VPD_mean",
      #"VPD_max", 
      #"VPD_min",
      #"VPD_max_95",
      #"annWatDef_95", 
      #"annWetDegDays_5",
       #"frostFreeDays_5",
      #"frostFreeDays",
      #"soilDepth",
      "clay", #7
      #"sand", 
      "coarse", #9
      "carbon", #10
      "AWHC" #11
   ) %>%
    #slice_sample(n = 5e4) %>% 
   cor()  %>% 
   caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) 
     #ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1)), progress = FALSE))

```
* 'annWatDef' and 'annWatDef_95': cor =  .98; chose 'annWatDef' (oppositve of function recommendation, but much easier to calculate)
* 'annWatDef' and 'prcp_seasonality': cor =  .82; chose 'prcp_seasonality'
* 'prcp' and 'annWetDegDays_5': cor =  .87; chose 'prcp' (opposite of recommendation by function, but prcp is easier to calculate )
* 'prcp' and 'annWetDegDays': cor =  .78; chose 'prcp' (opposite of recommendation by function, but prcp is easier to calculate)
* 'tmean' and 'VPD_max': cor =  .94; chose 'tmean' (opposite of recommendation by function, but tmean is easier to calculate)
* 'sand' and 'clay': cor =  .82; chose 'clay'


The final variables selected are shown below
```{r, echo = FALSE, fig.width= 9, fig.width = 8}
 (corrPlot <- 
   datGrassShrub %>% 
   dplyr::select(
              #"tmin", 
      #"tmax", 
      "tmean", #1
      "prcp", #2
      #"t_warm",
      #"t_cold",
      #"prcp_wet",
      "prcp_dry", #3
      "prcp_seasonality", #4
      "prcpTempCorr", #5
      #"abvFreezingMonth",
      "isothermality", #6
      #"annWatDef",
      #"annWetDegDays", 
      #"VPD_mean",
      #"VPD_max", 
      #"VPD_min",
      #"VPD_max_95",
      #"annWatDef_95", 
      #"annWetDegDays_5",
       #"frostFreeDays_5",
      #"frostFreeDays",
      #"soilDepth",
      "clay", #7
      #"sand", 
      "coarse", #9
      "carbon", #10
      "AWHC" #11
   ) %>%
    slice_sample(n = 5e4) %>% 
   # cor()  %>% 
   # caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) 
     ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1
                                                                                                  )), progress = FALSE))

grassShrubClimVars <- c(  #"tmin", 
              #"tmin", 
      #"tmax", 
      "tmean", #1
      "prcp", #2
      #"t_warm",
      #"t_cold",
      #"prcp_wet",
      "prcp_dry", #3
      "prcp_seasonality", #4
      "prcpTempCorr", #5
      #"abvFreezingMonth",
      "isothermality", #6
      #"annWatDef",
      #"annWetDegDays", 
      #"VPD_mean",
      #"VPD_max", 
      #"VPD_min",
      #"VPD_max_95",
      #"annWatDef_95", 
      #"annWetDegDays_5",
       #"frostFreeDays_5",
      #"frostFreeDays",
      #"soilDepth",
      "clay", #7
      #"sand", 
      "coarse", #9
      "carbon", #10
      "AWHC" #11
      )
```

### Treed areas

First, get data just for treed sites (based on classification from the bestLambda model) (and drop NAs )
```{r, echo = FALSE, include = FALSE}
## drop observations so we don't have any NAs
datForest <- dat %>% 
   select(tmin:frostFreeDays_anom,
         soilDepth:AWHC, treeProb_bestLambda_binary) %>% 
  drop_na()  %>% 
  filter(treeProb_bestLambda_binary == 1)
```

```{r, fig.width = 18, fig.height = 13}
#Here is the correlation structure of all of the potential input climate and soils variables
(corrPlot <- 
   datForest %>% 
      dplyr::select(
       "tmin", 
      "tmax", 
      "tmean",
      "prcp",
      "t_warm",
      "t_cold",
      "prcp_wet",
      "prcp_dry",
      "prcp_seasonality",
      "prcpTempCorr",
      "abvFreezingMonth",
      "isothermality",
      "annWatDef",
      "annWetDegDays",
      "VPD_mean",
      "VPD_max",
      "VPD_min",
      "VPD_max_95",
      "annWatDef_95",
      "annWetDegDays_5",
      "frostFreeDays_5",
      "frostFreeDays",
      "soilDepth",
      "clay",
      "sand",
      "coarse",
      "carbon",
      "AWHC"
   ) %>% 
    slice_sample(n = 5e3) %>% 
   #cor()  %>% 
   #caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) 
   ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=.1
                                                                                                )), progress = FALSE) #+ ggtitle("Correlation of Forest Predictor Variables")
 )
# bmp( here("Figures", "CoverDatFigures", "ForestClimVarCorrelations.bmp"), width = 2500, height = 2500)
# corrPlot
# dev.off()
```

The following variables were removed due to correlation with other variables -- first pass (vars. in parenthesis are kept):

* tmin, tmax, t_warm, t_cold (tmean)
* precip_wet (prcp)
* frostfreedays, frostfree days_5, abvfreezingmonth (tmin)
* VPD mean, VPD min, VPD max 95 (VPD_max)
* prcp_seasonality, annwatdef_95 (annwatdef)
* annwetdegdays_5 (annwetdegdays)
* soildepth (AWHC)

```{r, echo = FALSE, fig.width=14, fig.height=13}
(corrPlot <- 
   datForest %>% 
   dplyr::select(
      "tmean",
      "prcp",
      "prcp_dry",
      "prcpTempCorr",
      "isothermality",
      "annWatDef",
      "annWetDegDays",
      "VPD_max",
      "clay",
      "sand",
      "coarse",
      "carbon",
      "AWHC"
   ) %>%
    slice_sample(n = 5e4) %>% 
   #cor()  %>% 
   #caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) %>% 
     ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1)), progress = FALSE))

# bmp( here("Figures", "CoverDatFigures", "GrassShrubClimVarCorrelations_v2.bmp"), width = 2500, height = 2500)
# corrPlot
# dev.off()
```

Then, we removed the following additional variables based on their correlation: 

```{r, echo = FALSE}
 (corrPlot <- 
   datForest %>% 
   dplyr::select(
       "tmean", #1
      "prcp", #2
      "prcp_dry", #3
      "prcpTempCorr", #4
      "isothermality", #5
      "annWatDef", #6 
      #"annWetDegDays", 
      #"VPD_max", 
      #"clay",  #7
      "sand", #8
      "coarse", #9
      "carbon", #10
      "AWHC" #11
   ) %>%
    #slice_sample(n = 5e4) %>% 
   cor()  %>% 
   caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) 
     #ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1)), progress = FALSE))

```

* 'annWetDegDays' and 'tmean': cor =  .80; chose 'tmean'
* 'tmean' and 'VPD_max': cor =  .94; chose 'tmean' (opposite of what function recommends, but tmean is easier to calculate)
* 'sand' and 'clay': cor =  .74; chose 'sand' 


The final variables selected are shown below
```{r, echo = FALSE, fig.width= 9, fig.width = 8}
 (corrPlot <- 
   datForest %>% 
   dplyr::select(
      "tmean", #1
      "prcp", #2
      "prcp_dry", #3
      "prcpTempCorr", #4
      "isothermality", #5
      "annWatDef", #6 
      #"annWetDegDays", 
      #"VPD_max", 
      #"clay",  #7
      "sand", #8
      "coarse", #9
      "carbon", #10
      "AWHC" #11
   ) %>%
    slice_sample(n = 5e4) %>% 
   # cor()  %>% 
   # caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) 
     ggpairs( upper = list(continuous = my_fn, size = .1), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1)), progress = FALSE))


forestClimVars <- c(
   "tmean", #1
      "prcp", #2
      "prcp_dry", #3
      "prcpTempCorr", #4
      "isothermality", #5
      "annWatDef", #6 
      #"annWetDegDays", 
      #"VPD_max", 
      #"clay",  #7
      "sand", #8
      "coarse", #9
      "carbon", #10
      "AWHC" #11
     )

```


## Then, identify weather anomaly predictors that are uncorrelated with the climate and soils predictors identified above -- CONUS-wide, then uniquely for each ecoregion 

### CONUS
The following variables were removed due to correlation with other variables:

```{r, echo = FALSE, include=FALSE}
(corrPlot <- 
   datCONUS %>% 
   dplyr::select(all_of(conusClimVars), #1-#9

 # anomaly variables
    #tmean_anom , #10
     tmin_anom , #11
     tmax_anom , #12
     prcp_anom , #13
   t_warm_anom , #14
   #t_cold_anom , #15
      #prcp_wet_anom , #16
      precp_dry_anom , #17
    prcp_seasonality_anom , #18
     prcpTempCorr_anom , #19
      aboveFreezingMonth_anom , #20
    isothermality_anom , #21
       annWatDef_anom , #22
     annWetDegDays_anom , #23
      #VPD_mean_anom , #24
      VPD_min_anom , #25
      #VPD_max_anom , #26
    #  VPD_max_95_anom , 
    #   annWatDef_95_anom , 
    #   annWetDegDays_5_anom , 
    # frostFreeDays_5_anom, 
      #frostFreeDays_anom #27
   ) %>% 
    #slice_sample(n = 5e3) %>% 
   cor()  %>% 
   caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) #%>% 

```

* 'VPD_mean_anom' and 'tmean_anom': cor = .85; chose 'tmean_anom'
* 'tmean_anom' and 'tmin_anom': cor =  .86; chose 'tmin_anom'
* 'VPD_max_anom' and 't_warm_anom': cor =  .85; chose 't_warm_anom'
* 'frostFreeDays_anom' and 'aboveFreezingMonth_anom': cor =  .84; chose 'aboveFreezingMonth_anom'
* 't_cold_anom' and 'VPD_min_anom': cor =  .78; chose 'VPD_min_anom'
* 'prcp_anom' and 'prcp_wet_anom': cor =  .75; chose 'prcp_wet_anom'

The remaining variables that are uncorrelated are shown here: 
```{r final CONUS input vars, echo = FALSE, fig.width = 14, fig.height = 13}
  #ggpairs( upper = list(continuous = my_fn), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.2)), progress = FALSE))
# the findCorrelation() function says we should remove these variables: 

(corrPlot <- 
   datCONUS %>% 
   dplyr::select(conusClimVars, #1-#9

 # anomaly variables
       #tmean_anom , #10
     tmin_anom , #11
     tmax_anom , #12
     prcp_anom , #13
   t_warm_anom , #14
   #t_cold_anom , #15
      #prcp_wet_anom , #16
      precp_dry_anom , #17
    prcp_seasonality_anom , #18
     prcpTempCorr_anom , #19
      aboveFreezingMonth_anom , #20
    isothermality_anom , #21
       annWatDef_anom , #22
     annWetDegDays_anom , #23
      #VPD_mean_anom , #24
      VPD_min_anom , #25
      #VPD_max_anom , #26
    #  VPD_max_95_anom , 
    #   annWatDef_95_anom , 
    #   annWetDegDays_5_anom , 
    # frostFreeDays_5_anom, 
      #frostFreeDays_anom #27
   ) %>%
  slice_sample(n = 5e3) %>% 
    ggpairs( upper = list(continuous = my_fn), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1)), progress = FALSE))

corrPlotNames_conus <- names(corrPlot$data)
kable(data.frame("Climate_And_Soils_Variables" = c(corrPlotNames_conus[1:9],rep_len(NA,length.out = 3)), 
                 "Weather_Anomaly_Variables" = corrPlotNames_conus[10:length(corrPlotNames_conus)]), format = 'html') %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

```


### Un-treed areas
The following variables were removed due to correlation with other variables:

```{r, echo = FALSE, include=FALSE}
(corrPlot <- 
   datGrassShrub %>% 
   dplyr::select(all_of(grassShrubClimVars), #1-#10

 # anomaly variables
    #tmean_anom , #11
     tmin_anom , #12
     tmax_anom , #13
     #prcp_anom , #14
   t_warm_anom , #15
   #t_cold_anom , #16
      prcp_wet_anom , #17
      precp_dry_anom , #18
    prcp_seasonality_anom , #19
     prcpTempCorr_anom , #20
      #aboveFreezingMonth_anom , #21
    isothermality_anom , #22
       annWatDef_anom , #23
     annWetDegDays_anom , #24
      #VPD_mean_anom , #25
      VPD_min_anom , #26
      #VPD_max_anom , #27
     #VPD_max_95_anom , 
      #annWatDef_95_anom , 
      #annWetDegDays_5_anom , 
    # frostFreeDays_5_anom, 
      frostFreeDays_anom #28
   ) %>% 
    #slice_sample(n = 5e3) %>% 
   cor()  %>% 
   caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) #%>% 

```

* 'VPD_mean_anom' and 'tmean_anom': cor = .86; chose 'tmean_anom'
* 'tmean_anom' and 'tmax_anom': cor =  .81; chose 'tmax_anom'
* 'VPD_max_anom' and 't_warm_anom': cor =  .84; chose 't_warm_anom'
* 'prcp_anom' and 'prcp_wet_anom': cor =  .75; chose 'prcp_wet_anom'
* 't_cold_anom' and 'VPD_min_anom': cor =  .79; chose 'VPD_min_anom'
* 'frostFreeDays_anom' and 'aboveFreezingMonth_anom': cor =  .82; chose 'frostFreeDays_anom'



The remaining variables that are uncorrelated are shown here: 
```{r final grass shrub input vars, echo = FALSE, fig.width = 14, fig.height = 13}
  #ggpairs( upper = list(continuous = my_fn), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.2)), progress = FALSE))
# the findCorrelation() function says we should remove these variables: 

(corrPlot <- 
   datGrassShrub %>% 
   dplyr::select(grassShrubClimVars, #1-#10

 # anomaly variables
   #tmean_anom , #11
     tmin_anom , #12
     tmax_anom , #13
     #prcp_anom , #14
   t_warm_anom , #15
   #t_cold_anom , #16
      prcp_wet_anom , #17
      precp_dry_anom , #18
    prcp_seasonality_anom , #19
     prcpTempCorr_anom , #20
      #aboveFreezingMonth_anom , #21
    isothermality_anom , #22
       annWatDef_anom , #23
     annWetDegDays_anom , #24
      #VPD_mean_anom , #25
      VPD_min_anom , #26
      #VPD_max_anom , #27
     #VPD_max_95_anom , 
      #annWatDef_95_anom , 
      #annWetDegDays_5_anom , 
    # frostFreeDays_5_anom, 
      frostFreeDays_anom #28
   ) %>%
  slice_sample(n = 5e3) %>% 
    ggpairs( upper = list(continuous = my_fn), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1)), progress = FALSE))

corrPlotNames_grassShrub <- names(corrPlot$data)
kable(data.frame("Climate_And_Soils_Variables" = c(corrPlotNames_grassShrub[1:10],rep_len(NA,length.out = 2)), 
                 "Weather_Anomaly_Variables" = corrPlotNames_grassShrub[11:length(corrPlotNames_grassShrub)]), format = 'html') %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

```

### Treed areas

The following variables were removed due to correlation with other variables:
```{r, echo = FALSE, include=FALSE}
(corrPlot <- 
   datForest %>% 
   dplyr::select(
     all_of(forestClimVars), #1-#10
     
 # anomaly variables
     #tmean_anom , #11
     tmin_anom , #12
     tmax_anom , #13
     #prcp_anom , #14
   t_warm_anom , #15
   #t_cold_anom , #16
      prcp_wet_anom , #17
      precp_dry_anom , #18
    prcp_seasonality_anom , #19
     prcpTempCorr_anom , #20
      aboveFreezingMonth_anom , #21
    isothermality_anom , #22
       annWatDef_anom , #23
     annWetDegDays_anom , #24
      #VPD_mean_anom , #25
      VPD_min_anom #, #26
      #VPD_max_anom , #27
     # VPD_max_95_anom ,
      #annWatDef_95_anom , 
      #annWetDegDays_5_anom ,
    # frostFreeDays_5_anom , 
      #frostFreeDays_anom  #28
   ) %>%
    #slice_sample(n = 5e3) %>% 
   cor()  %>% 
   caret::findCorrelation(cutoff = .7, verbose = TRUE, names = TRUE, exact = TRUE)) #%>% 

```

* 'tmean_anom' and 'tmin_anom': cor =  .86; chose 'tmin_anom'
* 'VPD_mean_anom' and 'VPD_max_anom': cor =  .76; chose 'VPD_max_anom'
* 'VPD_max_anom' and 't_warm_anom': cor =  .88; chose 't_warm_anom'
* 'frostFreeDays_anom' and 'aboveFreezingMonth_anom': cor =  .88; chose 'aboveFreezingMonth_anom'
* 't_cold_anom' and 'VPD_min_anom': cor =  .73; chose 'VPD_min_anom'
* 'prcp_anom' and 'prcp_wet_anom': cor =  .75; chose 'prcp_wet_anom'



The remaining variables that are uncorrelated are shown below 
```{r, echo = FALSE, fig.width = 14, fig.height = 13}
(
corrPlot <- 
   datForest %>% 
   dplyr::select(     forestClimVars, #1-#11
 # anomaly variables
        #tmean_anom , #11
     tmin_anom , #12
     tmax_anom , #13
     #prcp_anom , #14
   t_warm_anom , #15
   #t_cold_anom , #16
      prcp_wet_anom , #17
      precp_dry_anom , #18
    prcp_seasonality_anom , #19
     prcpTempCorr_anom , #20
      aboveFreezingMonth_anom , #21
    isothermality_anom , #22
       annWatDef_anom , #23
     annWetDegDays_anom , #24
      #VPD_mean_anom , #25
      VPD_min_anom #, #26
      #VPD_max_anom , #27
     # VPD_max_95_anom ,
      #annWatDef_95_anom , 
      #annWetDegDays_5_anom ,
    # frostFreeDays_5_anom , 
      #frostFreeDays_anom  #28
   ) %>%
  slice_sample(n = 5e3) %>% 
    ggpairs( upper = list(continuous = my_fn), lower = list(continuous = GGally::wrap("points", alpha = 0.1, size=0.1)), progress = FALSE))

corrPlotNamesForest <- names(corrPlot$data)
kable(data.frame("Climate_And_Soils_Variables" = c(corrPlotNamesForest[1:10],rep_len(NA,length.out = 2)), 
                 "Weather_Anomaly_Variables" = corrPlotNamesForest[11:length(corrPlotNamesForest)]), format = 'html') %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

```

