---
title: "Generating final model predictions after relativizing"
author: "Alice Stears"
date: "`r lubridate::today()`"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
    dev: "jpeg"
params:
  readParams: TRUE
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE,
                      message = FALSE)
```

##User defined parameters and functions
```{r}
print(params)
# set to true if want to run for a limited number of rows (i.e. for code testing)
readParams <- params$readParams

makePredictions <- function(predictionDF, modelObject) {
  ##
  # predictionDF <- climDatPred
  # modelObject <- bestLambdaMod_grassShrub_totalHerb
  # ##
  
  # pretend to scale the input variables so the model object can predict accurately
  predictionDF <- predictionDF %>% 
  mutate(across(all_of(prednames), base::scale,scale = FALSE, center = FALSE)) 
  
  # modelPredictions
  modelPreds <- predict(object = modelObject, newdata = predictionDF, type = "response")
  # add predictions back into the input data.frame
  predictionDF <- predictionDF %>% 
    cbind(modelPreds)
  
  # truncate all predictions to max out at 100 
  #predictionDF[predictionDF$modelPreds>100 & !is.na(predictionDF$modelPreds),"modelPreds"] <- 100
predictionDF[predictionDF$modelPreds < 0 & !is.na(predictionDF$modelPreds),"modelPreds"] <- 0

  # print predicted data
 return(predictionDF)
}
```

## Dependencies 
```{r warning=FALSE, message=FALSE}
library(tidyverse)
library(sf)
library(terra)
library(kableExtra)
library(knitr)
library(USA.state.boundaries)
library(tidyterra)
library(ggpubr)
library(USA.state.boundaries)
```

## Read in necessary data 
```{r}
# Load Data ---------------------------------------------------------------
# data ready for modeling (that has been scaled)
modDat_1_s <- readRDS("./models/scaledModelInputData.rds")
  
# get the soil raster, which we'll use for rasterizing the imagery
soilRastTemp <- readRDS("../../../Data_processed/SoilsRaster.rds") %>% 
terra::unwrap()

# make a map of the predictions
test_rast <-  rast("../../../Data_raw/dayMet/rawMonthlyData/orders/70e0da02b9d2d6e8faa8c97d211f3546/Daymet_Monthly_V4R1/data/daymet_v4_prcp_monttl_na_1980.tif") %>% 
  terra::aggregate(fact = 12, fun = "mean")

# download map info for visualization
data(state_boundaries_wgs84) 

cropped_states <- suppressMessages(state_boundaries_wgs84 %>%
  dplyr::filter(NAME!="Hawaii") %>%
  dplyr::filter(NAME!="Alaska") %>%
  dplyr::filter(NAME!="Puerto Rico") %>%
  dplyr::filter(NAME!="American Samoa") %>%
  dplyr::filter(NAME!="Guam") %>%
  dplyr::filter(NAME!="Commonwealth of the Northern Mariana Islands") %>%
  dplyr::filter(NAME!="United States Virgin Islands") %>%
  dplyr::filter(NAME!= "U.S. Virgin Islands") %>% 
  sf::st_sf() %>%
  sf::st_transform(sf::st_crs(test_rast))) 
  #sf::st_crop(sf::st_bbox(modDat_1_sf)+c(-1,-1,1,1))

## add ecoregion boundaries (for our ecoregion level model)
regions <- sf::st_read(dsn = "../../../Data_raw/Level2Ecoregions/", layer = "NA_CEC_Eco_Level2") 
regions <- regions %>% 
  st_transform(crs = st_crs(test_rast)) %>% 
  st_make_valid() 
ecoregionLU <- data.frame("NA_L1NAME" = sort(unique(regions$NA_L1NAME)), 
                        "newRegion" = c(NA, "Forest", "dryShrubGrass", 
                                        "dryShrubGrass", "Forest", "dryShrubGrass",
                                       "dryShrubGrass", "Forest", "Forest", 
                                       "dryShrubGrass", "Forest", "Forest", 
                                       "Forest", "Forest", "dryShrubGrass", 
                                       NA
                                        ))
goodRegions <- regions %>% 
  left_join(ecoregionLU)
mapRegions <- goodRegions %>% 
  filter(!is.na(newRegion)) %>% 
  group_by(newRegion) %>% 
  summarise(geometry = sf::st_union(geometry)) %>% 
  ungroup() %>% 
  st_simplify(dTolerance = 1000)

## contemporary climate data
climDat_temp <- readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Data_processed/EcoRegion_climSoilData.rds")

climDat_timeTemp <- climDat_temp %>% 
  mutate(spatialID = paste0(round(x,4), "_", round(y,4))) %>% 
  drop_na()

spatID_lu <- data.frame("spatialID" = unique(climDat_timeTemp$spatialID), 
                        "uniqueID" = 1:length(unique(climDat_timeTemp$spatialID)))

climDat_timeTemp <- climDat_timeTemp %>% 
  left_join(spatID_lu)

## because of the spatial joining we did, there are some "locations" that have data for less than the true time span we want (2010-2020), or multiple observations per year... remove those so we have the even representation over the time span we're looking for 
set.seed("12011993")
goodTable <- data.frame(table(climDat_timeTemp$uniqueID))
goodIDs_temp <- as.numeric(goodTable[goodTable$Freq == 11,"Var1"])

#goodIDs <- unique(names(table(climDat_timeTemp$uniqueID))[(table(climDat_timeTemp$uniqueID)==11)])
# select 1000 random IDs
goodIDs <- goodIDs_temp[sample(x = 1:length(goodIDs_temp), size = 1000, replace = FALSE)]

## get climate data for 500 different points randomly chosen across CONUS for all years in the contemporary climate/weather/soils dataset 
climDat_time <- climDat_timeTemp %>% 
  filter(uniqueID %in% goodIDs) %>% 
  dplyr::select(tmin_meanAnnAvg_CLIM:durationFrostFreeDays_meanAnnAvg_3yrAnom, NA_L1CODE, 
         NA_L1NAME, NA_L1KEY, year, newRegion, x, y, soilDepth:totalAvailableWaterHoldingCapacity, uniqueID, spatialID) %>% 
rename("tmin" = tmin_meanAnnAvg_CLIM, 
     "tmax" = tmax_meanAnnAvg_CLIM, #1 
     "tmean" = tmean_meanAnnAvg_CLIM, 
     "prcp" = prcp_meanAnnTotal_CLIM, 
     "t_warm" = T_warmestMonth_meanAnnAvg_CLIM,
     "t_cold" = T_coldestMonth_meanAnnAvg_CLIM, 
     "prcp_wet" = precip_wettestMonth_meanAnnAvg_CLIM,
     "prcp_dry" = precip_driestMonth_meanAnnAvg_CLIM, 
     "prcp_seasonality" = precip_Seasonality_meanAnnAvg_CLIM, #2
     "prcpTempCorr" = PrecipTempCorr_meanAnnAvg_CLIM,  #3
     "abvFreezingMonth" = aboveFreezing_month_meanAnnAvg_CLIM, 
     "isothermality" = isothermality_meanAnnAvg_CLIM, #4
     "annWatDef" = annWaterDeficit_meanAnnAvg_CLIM, 
     "annWetDegDays" = annWetDegDays_meanAnnAvg_CLIM,
     "VPD_mean" = annVPD_mean_meanAnnAvg_CLIM, 
     "VPD_max" = annVPD_max_meanAnnAvg_CLIM, #5
     "VPD_min" = annVPD_min_meanAnnAvg_CLIM, #6
     "VPD_max_95" = annVPD_max_95percentile_CLIM, 
     "annWatDef_95" = annWaterDeficit_95percentile_CLIM, 
     "annWetDegDays_5" = annWetDegDays_5percentile_CLIM, 
     "frostFreeDays_5" = durationFrostFreeDays_5percentile_CLIM, 
     "frostFreeDays" = durationFrostFreeDays_meanAnnAvg_CLIM, 
     "soilDepth" = soilDepth, #7
     "clay" = surfaceClay_perc, 
     "sand" = avgSandPerc_acrossDepth, #8
     "coarse" = avgCoarsePerc_acrossDepth, #9
     "carbon" = avgOrganicCarbonPerc_0_3cm, #10
     "AWHC" = totalAvailableWaterHoldingCapacity,
     ## anomaly variables
     tmean_anom = tmean_meanAnnAvg_3yrAnom, #15
     tmin_anom = tmin_meanAnnAvg_3yrAnom, #16
     tmax_anom = tmax_meanAnnAvg_3yrAnom, #17
    prcp_anom = prcp_meanAnnTotal_3yrAnom, #18
      t_warm_anom = T_warmestMonth_meanAnnAvg_3yrAnom,  #19
     t_cold_anom = T_coldestMonth_meanAnnAvg_3yrAnom, #20
      prcp_wet_anom = precip_wettestMonth_meanAnnAvg_3yrAnom, #21
      precp_dry_anom = precip_driestMonth_meanAnnAvg_3yrAnom,  #22
    prcp_seasonality_anom = precip_Seasonality_meanAnnAvg_3yrAnom, #23 
     prcpTempCorr_anom = PrecipTempCorr_meanAnnAvg_3yrAnom, #24
      aboveFreezingMonth_anom = aboveFreezing_month_meanAnnAvg_3yrAnom, #25  
    isothermality_anom = isothermality_meanAnnAvg_3yrAnom, #26
       annWatDef_anom = annWaterDeficit_meanAnnAvg_3yrAnom, #27
     annWetDegDays_anom = annWetDegDays_meanAnnAvg_3yrAnom,  #28
      VPD_mean_anom = annVPD_mean_meanAnnAvg_3yrAnom, #29
      VPD_min_anom = annVPD_min_meanAnnAvg_3yrAnom,  #30
      VPD_max_anom = annVPD_max_meanAnnAvg_3yrAnom,  #31
     VPD_max_95_anom = annVPD_max_95percentile_3yrAnom, #32
      annWatDef_95_anom = annWaterDeficit_95percentile_3yrAnom, #33 
      annWetDegDays_5_anom = annWetDegDays_5percentile_3yrAnom ,  #34
    frostFreeDays_5_anom = durationFrostFreeDays_5percentile_3yrAnom, #35 
      frostFreeDays_anom = durationFrostFreeDays_meanAnnAvg_3yrAnom #36
  ) %>% 
  dplyr::select(-c(tmin_meanAnnAvg_3yr:Start_3yr)) 


# rename
climDat <- climDat_temp %>% 
  filter(year == 2016) %>% 
  dplyr::select(tmin_meanAnnAvg_CLIM:durationFrostFreeDays_meanAnnAvg_3yrAnom, NA_L1CODE, 
         NA_L1NAME, NA_L1KEY, newRegion, x, y, soilDepth:totalAvailableWaterHoldingCapacity) %>% 
rename("tmin" = tmin_meanAnnAvg_CLIM, 
     "tmax" = tmax_meanAnnAvg_CLIM, #1 
     "tmean" = tmean_meanAnnAvg_CLIM, 
     "prcp" = prcp_meanAnnTotal_CLIM, 
     "t_warm" = T_warmestMonth_meanAnnAvg_CLIM,
     "t_cold" = T_coldestMonth_meanAnnAvg_CLIM, 
     "prcp_wet" = precip_wettestMonth_meanAnnAvg_CLIM,
     "prcp_dry" = precip_driestMonth_meanAnnAvg_CLIM, 
     "prcp_seasonality" = precip_Seasonality_meanAnnAvg_CLIM, #2
     "prcpTempCorr" = PrecipTempCorr_meanAnnAvg_CLIM,  #3
     "abvFreezingMonth" = aboveFreezing_month_meanAnnAvg_CLIM, 
     "isothermality" = isothermality_meanAnnAvg_CLIM, #4
     "annWatDef" = annWaterDeficit_meanAnnAvg_CLIM, 
     "annWetDegDays" = annWetDegDays_meanAnnAvg_CLIM,
     "VPD_mean" = annVPD_mean_meanAnnAvg_CLIM, 
     "VPD_max" = annVPD_max_meanAnnAvg_CLIM, #5
     "VPD_min" = annVPD_min_meanAnnAvg_CLIM, #6
     "VPD_max_95" = annVPD_max_95percentile_CLIM, 
     "annWatDef_95" = annWaterDeficit_95percentile_CLIM, 
     "annWetDegDays_5" = annWetDegDays_5percentile_CLIM, 
     "frostFreeDays_5" = durationFrostFreeDays_5percentile_CLIM, 
     "frostFreeDays" = durationFrostFreeDays_meanAnnAvg_CLIM, 
     "soilDepth" = soilDepth, #7
     "clay" = surfaceClay_perc, 
     "sand" = avgSandPerc_acrossDepth, #8
     "coarse" = avgCoarsePerc_acrossDepth, #9
     "carbon" = avgOrganicCarbonPerc_0_3cm, #10
     "AWHC" = totalAvailableWaterHoldingCapacity,
     ## anomaly variables
     tmean_anom = tmean_meanAnnAvg_3yrAnom, #15
     tmin_anom = tmin_meanAnnAvg_3yrAnom, #16
     tmax_anom = tmax_meanAnnAvg_3yrAnom, #17
    prcp_anom = prcp_meanAnnTotal_3yrAnom, #18
      t_warm_anom = T_warmestMonth_meanAnnAvg_3yrAnom,  #19
     t_cold_anom = T_coldestMonth_meanAnnAvg_3yrAnom, #20
      prcp_wet_anom = precip_wettestMonth_meanAnnAvg_3yrAnom, #21
      precp_dry_anom = precip_driestMonth_meanAnnAvg_3yrAnom,  #22
    prcp_seasonality_anom = precip_Seasonality_meanAnnAvg_3yrAnom, #23 
     prcpTempCorr_anom = PrecipTempCorr_meanAnnAvg_3yrAnom, #24
      aboveFreezingMonth_anom = aboveFreezing_month_meanAnnAvg_3yrAnom, #25  
    isothermality_anom = isothermality_meanAnnAvg_3yrAnom, #26
       annWatDef_anom = annWaterDeficit_meanAnnAvg_3yrAnom, #27
     annWetDegDays_anom = annWetDegDays_meanAnnAvg_3yrAnom,  #28
      VPD_mean_anom = annVPD_mean_meanAnnAvg_3yrAnom, #29
      VPD_min_anom = annVPD_min_meanAnnAvg_3yrAnom,  #30
      VPD_max_anom = annVPD_max_meanAnnAvg_3yrAnom,  #31
     VPD_max_95_anom = annVPD_max_95percentile_3yrAnom, #32
      annWatDef_95_anom = annWaterDeficit_95percentile_3yrAnom, #33 
      annWetDegDays_5_anom = annWetDegDays_5percentile_3yrAnom ,  #34
    frostFreeDays_5_anom = durationFrostFreeDays_5percentile_3yrAnom, #35 
      frostFreeDays_anom = durationFrostFreeDays_meanAnnAvg_3yrAnom #36
  ) %>% 
  dplyr::select(-c(tmin_meanAnnAvg_3yr:Start_3yr))

rm(climDat_temp) 
gc()

## now, scale the contemporary climate data for use in models 
# get the scaling factors 
scaleParams <- modDat_1_s %>% 
  #filter(Year == 2016) %>% 
  dplyr::select(tmin_s:AWHC_s) %>% 
  reframe(across(all_of(names(.)), attributes)) 

# apply the scaling factors to the contemporary climate data 
namesToScale <- climDat %>% 
  dplyr::select(tmin:frostFreeDays, tmean_anom:frostFreeDays_anom, soilDepth:AWHC) %>% 
  names()

climDat_scaled <- map(namesToScale, .f = function(x) {
  x_new <- (climDat[,x] - scaleParams[,paste0(x, "_s")]$`scaled:center`)/scaleParams[,paste0(x, "_s")]$`scaled:scale`
  return(data.frame(x_new))
}) %>% 
  purrr::list_cbind()
names(climDat_scaled) <- paste0(namesToScale, "_s")

climDatPred <- climDat %>% 
  dplyr::select(NA_L1CODE:y) %>% 
  cbind(climDat_scaled)
names(climDatPred)[7:56] <- str_remove(names(climDatPred)[7:56], pattern = "_s$")

# apply the scaling factors to the contemporary climate data used for predictions over time 
climDat_scaled <- map(namesToScale, .f = function(x) {
  x_new <- (climDat_time[,x] - scaleParams[,paste0(x, "_s")]$`scaled:center`)/scaleParams[,paste0(x, "_s")]$`scaled:scale`
  return(data.frame(x_new))
}) %>% 
  purrr::list_cbind()
names(climDat_scaled) <- paste0(namesToScale, "_s")

climDat_time_Pred <- climDat_time %>% 
  dplyr::select(NA_L1CODE:y,spatialID) %>% 
  cbind(climDat_scaled)
names(climDat_time_Pred)[9:58] <- str_remove(names(climDat_time_Pred)[9:58], pattern = "_s$")

rm(climDat_scaled) 
gc()

prednames_s <-  modDat_1_s %>%
  dplyr::select(tmin_s:AWHC_s) %>%
  names()
prednames <- str_replace(prednames_s, pattern = "_s$", replacement = "")

## read in scaled data for future climate 
 forecastClimSoilsDatPred_1 <- readRDS(file = "../../../Data_processed/CoverData/IntermediateAnalysisFiles/Final_ForecastedClimateDataAndSoilsDataForPredictions_BNU-ESM_rcp8_5.rds")
 forecastClimSoilsDatPred_2 <- readRDS(file = "../../../Data_processed/CoverData/IntermediateAnalysisFiles/Final_ForecastedClimateDataAndSoilsDataForPredictions_IPSL-CM5A-MR_rcp8_5.rds")
  # read in unscaled data for future climate
 forecastClimSoilsDat_1 <- readRDS("../../../Data_processed/CoverData/IntermediateAnalysisFiles/Final_ForecastedClimateDataAndSoilsDataForPredictions_BNU-ESM_rcp8_5_UNSCALED.rds")
forecastClimSoilsDat_2 <- readRDS("../../../Data_processed/CoverData/IntermediateAnalysisFiles/Final_ForecastedClimateDataAndSoilsDataForPredictions_IPSL-CM5A-MR_rcp8_5_UNSCALED.rds")
```

## Now, predict using the entire hierarchy of models, starting with the ecoregion classification model 
### These are predictions of ecoregion classification using contemporary and modeled future climate data 
```{r}
ecoMod <- readRDS("../../ecoregionClassification/ModelFitting/ModelObjects/EcoregionClassificationModel.rds")

## print out model statement
coefficientTable <- data.frame(coefficients(ecoMod))
responseVar <- "P(forest)"
coefficientTable$coefficientName <- rownames(coefficientTable)
coefficientTable$coefficients.ecoMod. <- round(coefficientTable$coefficients.ecoMod., 4)
  
  # print out coefficients w/ coefficient names
tempNames <- paste0(
  apply(coefficientTable, MARGIN = 1, FUN = function(x) {
    if (x["coefficientName"] == "(Intercept)") {
      paste0(x["coefficients.ecoMod."])
    } else {  
      paste0(x["coefficients.ecoMod."], "*", x["coefficientName"])
    }
    }
  ),
  collapse = " + "
)

# print the unscaled model statement
  unscaledModelName <- paste0(responseVar, "~ 1/ (1 + exp(-(", tempNames,")))")
 print(unscaledModelName)
```
 
 Here are maps of the ecoregion model predictions with both contemporary and modeled future climate data 
```{r fig.width = 16, fig.height = 6, message = FALSE}
## get model data used for ecoregion fitting
modDat_ecoregionFit <- readRDS("../../../Data_processed/EcoRegion_climSoilData.rds")

modDat_ecoregionFit <- modDat_ecoregionFit %>% 
  rename("Long" = x, "Lat" = y) %>% 
  dplyr::select(c(newRegion, #swe_meanAnnAvg_CLIM:
                  tmin_meanAnnAvg_CLIM:durationFrostFreeDays_meanAnnAvg_CLIM,
                                         soilDepth                  , surfaceClay_perc          ,                
                                         avgSandPerc_acrossDepth    ,  avgCoarsePerc_acrossDepth,                 
                                         avgOrganicCarbonPerc_0_3cm ,  totalAvailableWaterHoldingCapacity,
                                         Long, Lat)) %>% 
  mutate(newRegion = as.factor(newRegion)) %>% 
  drop_na()

# get climate data from dayMet (d.f. is "climDatPred_unscaled")
climDatPred_unscaled <- climDat
names(climDatPred_unscaled)[c(5, 6, 7, 13, 10, 12, 98, 100, 101, 102)] <- c("T_warmestMonth_meanAnnAvg_CLIM", "T_coldestMonth_meanAnnAvg_CLIM", "precip_wettestMonth_meanAnnAvg_CLIM", "annWaterDeficit_meanAnnAvg_CLIM", "PrecipTempCorr_meanAnnAvg_CLIM", "isothermality_meanAnnAvg_CLIM", "soilDepth", "avgSandPerc_acrossDepth", "avgCoarsePerc_acrossDepth", "avgOrganicCarbonPerc_0_3cm")

#rm(climDat) 
#gc()

# predict with contemporary climate data 
preds_byHand <- climDatPred_unscaled %>% 
  mutate(pred = 1/(1 + exp(-( 9.8726 + -0.2999*T_warmestMonth_meanAnnAvg_CLIM +  0.2456*T_coldestMonth_meanAnnAvg_CLIM +  0.0106*precip_wettestMonth_meanAnnAvg_CLIM + -0.0621*annWaterDeficit_meanAnnAvg_CLIM + -2.7863*PrecipTempCorr_meanAnnAvg_CLIM +  0.0540*isothermality_meanAnnAvg_CLIM + -0.0076*soilDepth +  0.0335*avgSandPerc_acrossDepth +  0.0310*avgCoarsePerc_acrossDepth +  0.2726*avgOrganicCarbonPerc_0_3cm))))
#predictionsModel <- predict(object = ecoMod, type = "response", newdata = climDatPred_unscaled)

# predict with modeled future climate data v1
names(forecastClimSoilsDat_1)[c(8, 9, 10, 16, 13, 15, 48, 50, 51, 52)] <- c("T_warmestMonth_meanAnnAvg_CLIM", "T_coldestMonth_meanAnnAvg_CLIM", "precip_wettestMonth_meanAnnAvg_CLIM", "annWaterDeficit_meanAnnAvg_CLIM", "PrecipTempCorr_meanAnnAvg_CLIM", "isothermality_meanAnnAvg_CLIM", "soilDepth", "avgSandPerc_acrossDepth", "avgCoarsePerc_acrossDepth", "avgOrganicCarbonPerc_0_3cm")
preds_future1_byHand <- forecastClimSoilsDat_1 %>% 
  mutate(pred = 1/(1 + exp(-( 9.8726 + -0.2999*T_warmestMonth_meanAnnAvg_CLIM +  0.2456*T_coldestMonth_meanAnnAvg_CLIM +  0.0106*precip_wettestMonth_meanAnnAvg_CLIM + -0.0621*annWaterDeficit_meanAnnAvg_CLIM + -2.7863*PrecipTempCorr_meanAnnAvg_CLIM +  0.0540*isothermality_meanAnnAvg_CLIM + -0.0076*soilDepth +  0.0335*avgSandPerc_acrossDepth +  0.0310*avgCoarsePerc_acrossDepth +  0.2726*avgOrganicCarbonPerc_0_3cm))))

# predict with modeled future climate data v2
names(forecastClimSoilsDat_2)[c(8, 9, 10, 16, 13, 15, 48, 50, 51, 52)] <- c("T_warmestMonth_meanAnnAvg_CLIM", "T_coldestMonth_meanAnnAvg_CLIM", "precip_wettestMonth_meanAnnAvg_CLIM", "annWaterDeficit_meanAnnAvg_CLIM", "PrecipTempCorr_meanAnnAvg_CLIM", "isothermality_meanAnnAvg_CLIM", "soilDepth", "avgSandPerc_acrossDepth", "avgCoarsePerc_acrossDepth", "avgOrganicCarbonPerc_0_3cm")
preds_future2_byHand <- forecastClimSoilsDat_2 %>% 
  mutate(pred = 1/(1 + exp(-( 9.8726 + -0.2999*T_warmestMonth_meanAnnAvg_CLIM +  0.2456*T_coldestMonth_meanAnnAvg_CLIM +  0.0106*precip_wettestMonth_meanAnnAvg_CLIM + -0.0621*annWaterDeficit_meanAnnAvg_CLIM + -2.7863*PrecipTempCorr_meanAnnAvg_CLIM +  0.0540*isothermality_meanAnnAvg_CLIM + -0.0076*soilDepth +  0.0335*avgSandPerc_acrossDepth +  0.0310*avgCoarsePerc_acrossDepth +  0.2726*avgOrganicCarbonPerc_0_3cm))))


## Plot predictions with contemporary data
# make into a raster
plotObs <- preds_byHand %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "pred", 
                   fun = mean, na.rm = TRUE) 

# get the extent of this particular raster, and crop it accordingly

# get the extent of this particular raster, and crop it accordingly
tempExt <- crds(plotObs, na.rm = TRUE)

plotObs_2 <- plotObs %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

map_ecoRegion_current <- ggplot() +
  geom_spatraster(data = plotObs_2) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_2)),fill=NA ) +
labs(title = paste0("Ecoregion classification predictions using 
                    contemporary dayMet data")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey",
                       labels = c("grassShrub", "0.25", "0.50", "0.75", "forest")) + 
  xlim(st_bbox(plotObs_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_2)[c(2,4)])

# for future v1
plotObs_future1 <- preds_future1_byHand %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "pred", 
                   fun = mean, na.rm = TRUE)  
    
  
# get the extent of this particular raster, and crop it accordingly

plotObs_future1_2 <- plotObs_future1 %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

map_ecoRegion_future1 <- ggplot() +
  geom_spatraster(data = plotObs_future1_2) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_future1_2)),fill=NA ) +
labs(title = paste0("Ecoregion classification predictions using future 
climate data from the BNU-ESM model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey",
                       labels = c("grassShrub", "0.25", "0.50", "0.75", "forest")) + 
  xlim(st_bbox(plotObs_future1_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_future1_2)[c(2,4)])

# for future v2
plotObs_future2 <- preds_future2_byHand %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "pred", 
                   fun = mean, na.rm = TRUE)  
    
  

# get the extent of this particular raster, and crop it accordingly

plotObs_future2_2 <- plotObs_future2 %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

map_ecoRegion_future2 <- ggplot() +
  geom_spatraster(data = plotObs_future2_2) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_future2_2)),fill=NA ) +
labs(title = paste0("Ecoregion classification predictions using future 
climate data from the IPSL-CM5A-MR model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey",
                       labels = c("grassShrub", "0.25", "0.50", "0.75", "forest")) + 
  xlim(st_bbox(plotObs_future2_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_future2_2)[c(2,4)])

## Plot the maps together
  ggarrange(map_ecoRegion_current, map_ecoRegion_future1, map_ecoRegion_future2, nrow = 1) %>% 
  annotate_figure(fig.lab = "Model Predictions of Ecoregion Classification with Contemporary and Forecasted Climate Data", fig.lab.size = 20)
```
 
## get model objects for cover models
```{r}
# Total herbaceous cover: 
# Grass/shrub: 1SE lambda model
totalHerb_GS <- readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Analysis/VegComposition/ModelFitting/models/TotalHerbaceousCover_shrubGrass_noTLP_FALSE_trimAnom_oneSELambdaGLM.rds")
# Forest: best lambda model
totalHerb_F <-  readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Analysis/VegComposition/ModelFitting/models/TotalHerbaceousCover_forest_noTLP_FALSE_trimAnom_bestLambdaGLM.rds")

# Total tree cover: 
# Grass/shrub: best lambda model 
totalTree_GS <- readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Analysis/VegComposition/ModelFitting/models/TotalTreeCover_shrubGrass_noTLP_FALSE_trimAnom_bestLambdaGLM.rds")
# Forest: best lambda model 
totalTree_F <- readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Analysis/VegComposition/ModelFitting/models/TotalTreeCover_forest_noTLP_FALSE_trimAnom_bestLambdaGLM.rds")
  
# Bare ground: 
# CONUS - 1SE lambda model
bareGround_CONUS <-  readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Analysis/VegComposition/ModelFitting/models/BareGroundCover_CONUS_noTLP_FALSE_trimAnom_oneSELambdaGLM.rds")

# Shrub: 
# CONUS - best lambda model
shrub_CONUS <- readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Analysis/VegComposition/ModelFitting/models/ShrubCover_CONUS_noTLP_FALSE_trimAnom_bestLambdaGLM.rds")

# Broad-leaved tree: 
# Grass/shrub: best lambda model
BLtree_GS <-  readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Analysis/VegComposition/ModelFitting/models/AngioTreeCover_prop_shrubGrass_noTLP_FALSE_trimAnom_bestLambdaGLM.rds")
# Forest:  best lambda model
BLtree_F <- readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Analysis/VegComposition/ModelFitting/models/AngioTreeCover_prop_forest_noTLP_FALSE_trimAnom_bestLambdaGLM.rds")

  
# Needle-leaved tree: 
# Grass/shrub: best lambda model
NLtree_GS <-  readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Analysis/VegComposition/ModelFitting/models/ConifTreeCover_prop_shrubGrass_noTLP_FALSE_trimAnom_bestLambdaGLM.rds")
# Forest:  best lambda model
NLtree_F <- readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Analysis/VegComposition/ModelFitting/models/ConifTreeCover_prop_forest_noTLP_FALSE_trimAnom_bestLambdaGLM.rds")

# Forb:
# CONUS: best lambda model
forb_CONUS <-  readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Analysis/VegComposition/ModelFitting/models/ForbCover_prop_CONUS_noTLP_FALSE_trimAnom_bestLambdaGLM.rds")

# C3 grass:
# CONUS: 1SE lambda model
C3grass_CONUS <- readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Analysis/VegComposition/ModelFitting/models/C3GramCover_prop_CONUS_noTLP_FALSE_trimAnom_oneSELambdaGLM.rds")

# C4 grass: 
# CONUS: best lambda model
C4grass_CONUS <- readRDS("/Users/astears/Documents/Dropbox_static/Work/NAU_USGS_postdoc/PED_vegClimModels/Analysis/VegComposition/ModelFitting/models/C4GramCover_prop_CONUS_noTLP_FALSE_trimAnom_bestLambdaGLM.rds")

```

## Now, predict absolute cover with scaled climate/weather/soils data 
```{r}
## with contemporary climate data
totalHerb_F_predsContemp <- makePredictions(predictionDF = climDatPred,
                                            modelObject = totalHerb_F) %>% 
  rename(absTotalHerb_F = "modelPreds")
totalHerb_GS_predsContemp <- makePredictions(predictionDF = climDatPred,
                                            modelObject = totalHerb_GS) %>% 
  rename(absTotalHerb_GS = "modelPreds")

totalTree_F_predsContemp<- makePredictions(predictionDF = climDatPred,
                                            modelObject = totalTree_F) %>% 
  rename(absTotalTree_F = "modelPreds")
totalTree_GS_predsContemp<- makePredictions(predictionDF = climDatPred,
                                            modelObject = totalTree_GS) %>% 
  rename(absTotalTree_GS = "modelPreds")

bareGround_CONUS_predsContemp<- makePredictions(predictionDF = climDatPred,
                                            modelObject = bareGround_CONUS) %>% 
  rename(absBareGround_CONUS = "modelPreds")

shrub_CONUS_predsContemp<- makePredictions(predictionDF = climDatPred,
                                            modelObject = shrub_CONUS) %>% 
  rename(absShrub_CONUS = "modelPreds")

BLtree_F_predsContemp<- makePredictions(predictionDF = climDatPred,
                                            modelObject = BLtree_F) %>% 
  rename(percBLTree_F = "modelPreds")
BLtree_GS_predsContemp<- makePredictions(predictionDF = climDatPred,
                                            modelObject = BLtree_GS) %>% 
  rename(percBLTree_GS = "modelPreds")

NLtree_F_predsContemp<- makePredictions(predictionDF = climDatPred,
                                            modelObject = NLtree_F) %>% 
  rename(percNLTree_F = "modelPreds")
NLtree_GS_predsContemp<- makePredictions(predictionDF = climDatPred,
                                            modelObject = NLtree_GS) %>% 
  rename(percNLTree_GS = "modelPreds")

C3grass_CONUS_predsContemp<- makePredictions(predictionDF = climDatPred,
                                            modelObject = C3grass_CONUS) %>% 
  rename(percC3grass_CONUS = "modelPreds")

C4grass_CONUS_predsContemp<- makePredictions(predictionDF = climDatPred,
                                            modelObject = C4grass_CONUS) %>% 
  rename(percC4grass_CONUS = "modelPreds")

forb_CONUS_predsContemp<- makePredictions(predictionDF = climDatPred,
                                            modelObject = forb_CONUS) %>% 
  rename(percForb_CONUS = "modelPreds")

contempPreds <- totalHerb_F_predsContemp  %>% 
  cbind(totalHerb_GS_predsContemp %>% select(absTotalHerb_GS)) %>% 
  cbind(totalTree_F_predsContemp %>% select(absTotalTree_F)) %>% 
  cbind(totalTree_GS_predsContemp %>% select(absTotalTree_GS)) %>% 
  cbind(bareGround_CONUS_predsContemp %>% select(absBareGround_CONUS)) %>% 
  cbind(shrub_CONUS_predsContemp %>% select(absShrub_CONUS)) %>% 
  cbind(BLtree_F_predsContemp %>% select(percBLTree_F)) %>% 
  cbind(BLtree_GS_predsContemp %>% select(percBLTree_GS)) %>% 
  cbind(NLtree_F_predsContemp %>% select(percNLTree_F)) %>% 
  cbind(NLtree_GS_predsContemp %>% select(percNLTree_GS)) %>% 
  cbind(C3grass_CONUS_predsContemp %>% select(percC3grass_CONUS)) %>% 
  cbind(C4grass_CONUS_predsContemp %>% select(percC4grass_CONUS)) %>% 
  cbind(forb_CONUS_predsContemp %>% select(percForb_CONUS)) %>% 
  cbind(preds_byHand %>% select(pred)) %>% 
  rename(prob_Forest = "pred") %>% 
  mutate(prob_grassShrub = 1 - prob_Forest)

# get predictions with first climate model 
## with contemporary climate data
totalHerb_F_predsFuture1 <- makePredictions(predictionDF = forecastClimSoilsDatPred_1,
                                            modelObject = totalHerb_F) %>% 
  rename(absTotalHerb_F = "modelPreds")
totalHerb_GS_predsFuture1 <- makePredictions(predictionDF = forecastClimSoilsDatPred_1,
                                            modelObject = totalHerb_GS) %>% 
  rename(absTotalHerb_GS = "modelPreds")

totalTree_F_predsFuture1<- makePredictions(predictionDF = forecastClimSoilsDatPred_1,
                                            modelObject = totalTree_F) %>% 
  rename(absTotalTree_F = "modelPreds")
totalTree_GS_predsFuture1<- makePredictions(predictionDF = forecastClimSoilsDatPred_1,
                                            modelObject = totalTree_GS) %>% 
  rename(absTotalTree_GS = "modelPreds")

bareGround_CONUS_predsFuture1<- makePredictions(predictionDF = forecastClimSoilsDatPred_1,
                                            modelObject = bareGround_CONUS) %>% 
  rename(absBareGround_CONUS = "modelPreds")

shrub_CONUS_predsFuture1<- makePredictions(predictionDF = forecastClimSoilsDatPred_1,
                                            modelObject = shrub_CONUS) %>% 
  rename(absShrub_CONUS = "modelPreds")

BLtree_F_predsFuture1<- makePredictions(predictionDF = forecastClimSoilsDatPred_1,
                                            modelObject = BLtree_F) %>% 
  rename(percBLTree_F = "modelPreds")
BLtree_GS_predsFuture1<- makePredictions(predictionDF = forecastClimSoilsDatPred_1,
                                            modelObject = BLtree_GS) %>% 
  rename(percBLTree_GS = "modelPreds")

NLtree_F_predsFuture1<- makePredictions(predictionDF = forecastClimSoilsDatPred_1,
                                            modelObject = NLtree_F) %>% 
  rename(percNLTree_F = "modelPreds")
NLtree_GS_predsFuture1<- makePredictions(predictionDF = forecastClimSoilsDatPred_1,
                                            modelObject = NLtree_GS) %>% 
  rename(percNLTree_GS = "modelPreds")

C3grass_CONUS_predsFuture1<- makePredictions(predictionDF = forecastClimSoilsDatPred_1,
                                            modelObject = C3grass_CONUS) %>% 
  rename(percC3grass_CONUS = "modelPreds")

C4grass_CONUS_predsFuture1<- makePredictions(predictionDF = forecastClimSoilsDatPred_1,
                                            modelObject = C4grass_CONUS) %>% 
  rename(percC4grass_CONUS = "modelPreds")

forb_CONUS_predsFuture1<- makePredictions(predictionDF = forecastClimSoilsDatPred_1,
                                            modelObject = forb_CONUS) %>% 
  rename(percForb_CONUS = "modelPreds")

predsFuture1 <- totalHerb_F_predsFuture1  %>% 
  cbind(totalHerb_GS_predsFuture1 %>% select(absTotalHerb_GS)) %>% 
  cbind(totalTree_F_predsFuture1 %>% select(absTotalTree_F)) %>% 
  cbind(totalTree_GS_predsFuture1 %>% select(absTotalTree_GS)) %>% 
  cbind(bareGround_CONUS_predsFuture1 %>% select(absBareGround_CONUS)) %>% 
  cbind(shrub_CONUS_predsFuture1 %>% select(absShrub_CONUS)) %>% 
  cbind(BLtree_F_predsFuture1 %>% select(percBLTree_F)) %>% 
  cbind(BLtree_GS_predsFuture1 %>% select(percBLTree_GS)) %>% 
  cbind(NLtree_F_predsFuture1 %>% select(percNLTree_F)) %>% 
  cbind(NLtree_GS_predsFuture1 %>% select(percNLTree_GS)) %>% 
  cbind(C3grass_CONUS_predsFuture1 %>% select(percC3grass_CONUS)) %>% 
  cbind(C4grass_CONUS_predsFuture1 %>% select(percC4grass_CONUS)) %>% 
  cbind(forb_CONUS_predsFuture1 %>% select(percForb_CONUS)) %>% 
  cbind(preds_future1_byHand %>% select(pred)) %>% 
  rename(prob_Forest = "pred") %>% 
  mutate(prob_grassShrub = 1 - prob_Forest)

# get predictions with second climate model
totalHerb_F_predsFuture2 <- makePredictions(predictionDF = forecastClimSoilsDatPred_2,
                                            modelObject = totalHerb_F) %>% 
  rename(absTotalHerb_F = "modelPreds")
totalHerb_GS_predsFuture2 <- makePredictions(predictionDF = forecastClimSoilsDatPred_2,
                                            modelObject = totalHerb_GS) %>% 
  rename(absTotalHerb_GS = "modelPreds")

totalTree_F_predsFuture2<- makePredictions(predictionDF = forecastClimSoilsDatPred_2,
                                            modelObject = totalTree_F) %>% 
  rename(absTotalTree_F = "modelPreds")
totalTree_GS_predsFuture2<- makePredictions(predictionDF = forecastClimSoilsDatPred_2,
                                            modelObject = totalTree_GS) %>% 
  rename(absTotalTree_GS = "modelPreds")

bareGround_CONUS_predsFuture2<- makePredictions(predictionDF = forecastClimSoilsDatPred_2,
                                            modelObject = bareGround_CONUS) %>% 
  rename(absBareGround_CONUS = "modelPreds")

shrub_CONUS_predsFuture2<- makePredictions(predictionDF = forecastClimSoilsDatPred_2,
                                            modelObject = shrub_CONUS) %>% 
  rename(absShrub_CONUS = "modelPreds")

BLtree_F_predsFuture2<- makePredictions(predictionDF = forecastClimSoilsDatPred_2,
                                            modelObject = BLtree_F) %>% 
  rename(percBLTree_F = "modelPreds")
BLtree_GS_predsFuture2<- makePredictions(predictionDF = forecastClimSoilsDatPred_2,
                                            modelObject = BLtree_GS) %>% 
  rename(percBLTree_GS = "modelPreds")

NLtree_F_predsFuture2<- makePredictions(predictionDF = forecastClimSoilsDatPred_2,
                                            modelObject = NLtree_F) %>% 
  rename(percNLTree_F = "modelPreds")
NLtree_GS_predsFuture2<- makePredictions(predictionDF = forecastClimSoilsDatPred_2,
                                            modelObject = NLtree_GS) %>% 
  rename(percNLTree_GS = "modelPreds")

C3grass_CONUS_predsFuture2<- makePredictions(predictionDF = forecastClimSoilsDatPred_2,
                                            modelObject = C3grass_CONUS) %>% 
  rename(percC3grass_CONUS = "modelPreds")

C4grass_CONUS_predsFuture2<- makePredictions(predictionDF = forecastClimSoilsDatPred_2,
                                            modelObject = C4grass_CONUS) %>% 
  rename(percC4grass_CONUS = "modelPreds")

forb_CONUS_predsFuture2<- makePredictions(predictionDF = forecastClimSoilsDatPred_2,
                                            modelObject = forb_CONUS) %>% 
  rename(percForb_CONUS = "modelPreds")

predsFuture2 <- totalHerb_F_predsFuture2  %>% 
  cbind(totalHerb_GS_predsFuture2 %>% select(absTotalHerb_GS)) %>% 
  cbind(totalTree_F_predsFuture2 %>% select(absTotalTree_F)) %>% 
  cbind(totalTree_GS_predsFuture2 %>% select(absTotalTree_GS)) %>% 
  cbind(bareGround_CONUS_predsFuture2 %>% select(absBareGround_CONUS)) %>% 
  cbind(shrub_CONUS_predsFuture2 %>% select(absShrub_CONUS)) %>% 
  cbind(BLtree_F_predsFuture2 %>% select(percBLTree_F)) %>% 
  cbind(BLtree_GS_predsFuture2 %>% select(percBLTree_GS)) %>% 
  cbind(NLtree_F_predsFuture2 %>% select(percNLTree_F)) %>% 
  cbind(NLtree_GS_predsFuture2 %>% select(percNLTree_GS)) %>% 
  cbind(C3grass_CONUS_predsFuture2 %>% select(percC3grass_CONUS)) %>% 
  cbind(C4grass_CONUS_predsFuture2 %>% select(percC4grass_CONUS)) %>% 
  cbind(forb_CONUS_predsFuture2 %>% select(percForb_CONUS)) %>% 
  cbind(preds_future2_byHand %>% select(pred)) %>% 
  rename(prob_Forest = "pred") %>% 
  mutate(prob_grassShrub = 1 - prob_Forest)

```

## "Scale" absolute cover predictions according to predicted ecoregion probability
```{r}
## for contemporary data
contempPreds <- contempPreds %>% 
  mutate(absTotalHerb_CONUS = (prob_grassShrub * absTotalHerb_GS) + (prob_Forest * absTotalHerb_F),
         absTotalTree_CONUS = (prob_grassShrub * absTotalTree_GS) + (prob_Forest * absTotalTree_F),
         percBLTree_CONUS = (prob_grassShrub * percBLTree_GS) + (prob_Forest * percBLTree_F),
         percNLTree_CONUS = (prob_grassShrub * percNLTree_GS) + (prob_Forest * percNLTree_F)
         )

## for first climate model
predsFuture1 <- predsFuture1 %>% 
  mutate(absTotalHerb_CONUS = (prob_grassShrub * absTotalHerb_GS) + (prob_Forest * absTotalHerb_F),
         absTotalTree_CONUS = (prob_grassShrub * absTotalTree_GS) + (prob_Forest * absTotalTree_F),
         percBLTree_CONUS = (prob_grassShrub * percBLTree_GS) + (prob_Forest * percBLTree_F),
         percNLTree_CONUS = (prob_grassShrub * percNLTree_GS) + (prob_Forest * percNLTree_F)
         )

## for second climate model 
predsFuture2 <- predsFuture2 %>% 
  mutate(absTotalHerb_CONUS = (prob_grassShrub * absTotalHerb_GS) + (prob_Forest * absTotalHerb_F),
         absTotalTree_CONUS = (prob_grassShrub * absTotalTree_GS) + (prob_Forest * absTotalTree_F),
         percBLTree_CONUS = (prob_grassShrub * percBLTree_GS) + (prob_Forest * percBLTree_F),
         percNLTree_CONUS = (prob_grassShrub * percNLTree_GS) + (prob_Forest * percNLTree_F)
         )
```

## Convert percentages for level 2 cover into absolute cover values
```{r}
## for contemporary data
contempPreds <- contempPreds %>% 
  mutate(absNLTree_CONUS = (percNLTree_CONUS * absTotalTree_CONUS), 
         absBLTree_CONUS = (percBLTree_CONUS * absTotalTree_CONUS), 
         absC3grass_CONUS = (percC3grass_CONUS * absTotalHerb_CONUS),
         absC4grass_CONUS = (percC4grass_CONUS * absTotalHerb_CONUS),
         absForb_CONUS = (percForb_CONUS * absTotalHerb_CONUS)
  )

## for first climate model
predsFuture1 <- predsFuture1 %>% 
  mutate(absNLTree_CONUS = (percNLTree_CONUS * absTotalTree_CONUS), 
         absBLTree_CONUS = (percBLTree_CONUS * absTotalTree_CONUS), 
         absC3grass_CONUS = (percC3grass_CONUS * absTotalHerb_CONUS),
         absC4grass_CONUS = (percC4grass_CONUS * absTotalHerb_CONUS),
         absForb_CONUS = (percForb_CONUS * absTotalHerb_CONUS)
  )

## for second climate model 
predsFuture2 <- predsFuture2 %>% 
  mutate(absNLTree_CONUS = (percNLTree_CONUS * absTotalTree_CONUS), 
         absBLTree_CONUS = (percBLTree_CONUS * absTotalTree_CONUS), 
         absC3grass_CONUS = (percC3grass_CONUS * absTotalHerb_CONUS),
         absC4grass_CONUS = (percC4grass_CONUS * absTotalHerb_CONUS),
         absForb_CONUS = (percForb_CONUS * absTotalHerb_CONUS)
  )
```


## Show predictions of absolute cover, CONUS-wide (after scaling according to ecoregion classification probability) 
```{r}
# list of absolute cover names
responseNames <- c("absTotalTree_CONUS", "absTotalHerb_CONUS", "absShrub_CONUS", "absBareGround_CONUS", "absNLTree_CONUS", "absBLTree_CONUS", "absC3grass_CONUS", "absC4grass_CONUS", "absForb_CONUS")

absoluteCoverMaps_contemp <- lapply(responseNames, 
                                      FUN = function(x) {
                                       ## contemporary absolute cover
                                        # rasterize response 
                                        resp_rast <- contempPreds %>% 
                                          terra::vect(geom = c("x", "y")) %>% 
                                          terra::set.crs(crs(test_rast)) %>% 
                                          terra::rasterize(y = test_rast, 
                                                           field = x, 
                                                           fun = mean, na.rm = TRUE)   
                                        # get the extent of this particular raster, and crop it accordingly
                                        resp_rast_2 <- resp_rast %>% 
                                          crop(ext(min(tempExt[,1]), max(tempExt[,1]),
                                                   min(tempExt[,2]), max(tempExt[,2])) 
                                               )
                                        # make a map
                                        resp_map <- ggplot() +
                                          geom_spatraster(data = resp_rast_2) +
                                          geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>%
                                                    st_crop(st_bbox(plotObs_2)),fill=NA ) +
                                                    labs(title = paste0("Predictions of absolute cover of ",x,", 
                                                    \n after scaling according to ecoregion prediction")) +
                                          scale_fill_gradient2(low = "brown",
                                                               mid = "wheat" ,
                                                               high = "darkgreen" , 
                                                               midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
                                          xlim(st_bbox(plotObs_2)[c(1,3)]) + 
                                          ylim(st_bbox(plotObs_2)[c(2,4)]) + 
                                          theme_classic()
                                        
                                        # make a histogram
                                        resp_hist <- ggplot() + 
                                          geom_density(aes(contempPreds[,x]), col = "black", fill = "darkgrey") + 
                                          xlab(paste0("Predictions of absolute cover of ",x)) +
                                          theme_classic()
                                        
                                         ## future model 1 absolute cover
                                        # rasterize response 
                                        resp_rast_future1 <- predsFuture1 %>% 
                                          terra::vect(geom = c("x", "y")) %>% 
                                          terra::set.crs(crs(test_rast)) %>% 
                                          terra::rasterize(y = test_rast, 
                                                           field = x, 
                                                           fun = mean, na.rm = TRUE)   
                                        # get the extent of this particular raster, and crop it accordingly
                                        resp_rast_future1_2 <- resp_rast_future1 %>% 
                                          crop(ext(min(tempExt[,1]), max(tempExt[,1]),
                                                   min(tempExt[,2]), max(tempExt[,2])) 
                                               )
                                        # calculate differences between contemporary preds and future 1 preds (deltas)
                                        rast_deltas_future1 <- resp_rast_future1_2 - resp_rast_2
                                        # make a map
                                        resp_map_future1 <- ggplot() +
                                          geom_spatraster(data = rast_deltas_future1) +
                                          geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>%
                                                    st_crop(st_bbox(plotObs_2)),fill=NA ) +
                                                    labs(title = paste0("Future predictions of absolute cover of ",x,", \n compared to contemporary predictions (future - contemprary)  \n - climate model: BNU-ESM")) +
                                          scale_fill_gradient2(low = "orange",
                                                               mid = "white" ,
                                                               high = "purple" , 
                                                               midpoint = 0, limits = c(-1,1),  na.value = "lightgrey") + 
                                          xlim(st_bbox(plotObs_2)[c(1,3)]) + 
                                          ylim(st_bbox(plotObs_2)[c(2,4)]) + 
                                          theme_classic()
                                        
                                        # make a histogram
                                        resp_hist_future1 <- ggplot() + 
                                          geom_density(aes(predsFuture1[,x]), col = "black", fill = "darkgrey") + 
                                          xlab(paste0("Predictions of absolute cover of ",x, 
                                                      " \n in future scenario (model = BNU-ESM)")) +
                                          theme_classic()
                                        
                                        ## future model 2 absolute cover
                                        # rasterize response 
                                        resp_rast_future2 <- predsFuture2 %>% 
                                          terra::vect(geom = c("x", "y")) %>% 
                                          terra::set.crs(crs(test_rast)) %>% 
                                          terra::rasterize(y = test_rast, 
                                                           field = x, 
                                                           fun = mean, na.rm = TRUE)   
                                        # get the extent of this particular raster, and crop it accordingly
                                        resp_rast_future2_2 <- resp_rast_future2 %>% 
                                          crop(ext(min(tempExt[,1]), max(tempExt[,1]),
                                                   min(tempExt[,2]), max(tempExt[,2])) 
                                               )
                                        # calculate differences between contemporary preds and future 1 preds (deltas)
                                        rast_deltas_future2 <- resp_rast_future2_2 - resp_rast_2
                                        # make a map
                                        resp_map_future2 <- ggplot() +
                                          geom_spatraster(data = rast_deltas_future2) +
                                          geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>%
                                                    st_crop(st_bbox(plotObs_2)),fill=NA ) +
                                                    labs(title = paste0("Future predictions of absolute cover of ",x,", \n compared to contemporary predictions (future - contemprary) \n- climate model: IPSL-CM5A-MR (France)")) +
                                          scale_fill_gradient2(low = "orange",
                                                               mid = "white" ,
                                                               high = "purple" , 
                                                               midpoint = 0, limits = c(-1,1),  na.value = "lightgrey") + 
                                          xlim(st_bbox(plotObs_2)[c(1,3)]) + 
                                          ylim(st_bbox(plotObs_2)[c(2,4)]) + 
                                          theme_classic()
                                        
                                        # make a histogram
                                        resp_hist_future2 <- ggplot() + 
                                          geom_density(aes(predsFuture2[,x]), col = "black", fill = "darkgrey") + 
                                          xlab(paste0("Predictions of absolute cover of ",x, 
                                                      " \n in future scenario (model = IPSL-CM5A-MR (France))")) +
                                          theme_classic()
                                        
                                        
                                        return(list("rast" = resp_rast_2, 
                                                    "map" = resp_map, 
                                                    "hist" = resp_hist,
                                                    "rast_future1" = resp_rast_future1_2,
                                                    "map_future1" = resp_map_future1, 
                                                    "hist_future1" = resp_hist_future1,
                                                    "rast_future2" = resp_rast_future2_2,
                                                    "map_future2" = resp_map_future2, 
                                                    "hist_future2" = resp_hist_future2))
                                      })


names(absoluteCoverMaps_contemp) <- c("absTotalTree_CONUS", "absTotalHerb_CONUS", "absShrub_CONUS", "absBareGround_CONUS", "absNLTree_CONUS", "absBLTree_CONUS", "absC3grass_CONUS", "absC4grass_CONUS", "absForb_CONUS")

```

```{r  fig.height=60, fig.width=18}
ggarrange(
ggarrange(absoluteCoverMaps_contemp$absTotalTree_CONUS$map, 
          absoluteCoverMaps_contemp$absTotalTree_CONUS$map_future1,
          absoluteCoverMaps_contemp$absTotalTree_CONUS$map_future2,
          absoluteCoverMaps_contemp$absTotalTree_CONUS$hist,
           absoluteCoverMaps_contemp$absTotalTree_CONUS$hist_future1, absoluteCoverMaps_contemp$absTotalTree_CONUS$hist_future2,
          ncol = 3,
          nrow = 2,
          heights = c(1,.35)
          ),
ggarrange(absoluteCoverMaps_contemp$absTotalHerb_CONUS$map, 
          absoluteCoverMaps_contemp$absTotalHerb_CONUS$map_future1,
          absoluteCoverMaps_contemp$absTotalHerb_CONUS$map_future2,
          absoluteCoverMaps_contemp$absTotalHerb_CONUS$hist,
          absoluteCoverMaps_contemp$absTotalHerb_CONUS$hist_future1, 
          absoluteCoverMaps_contemp$absTotalHerb_CONUS$hist_future2,
          ncol = 3,
          nrow = 2,
          heights = c(1,.35)
          ),
ggarrange(absoluteCoverMaps_contemp$absShrub_CONUS$map, 
          absoluteCoverMaps_contemp$absShrub_CONUS$map_future1,
          absoluteCoverMaps_contemp$absShrub_CONUS$map_future2,
          absoluteCoverMaps_contemp$absShrub_CONUS$hist,
          absoluteCoverMaps_contemp$absShrub_CONUS$hist_future1, 
          absoluteCoverMaps_contemp$absShrub_CONUS$hist_future2,
          ncol = 3,
          nrow = 2,
          heights = c(1,.35)
          ),
ggarrange(absoluteCoverMaps_contemp$absBareGround_CONUS$map, 
          absoluteCoverMaps_contemp$absBareGround_CONUS$map_future1,
          absoluteCoverMaps_contemp$absBareGround_CONUS$map_future2,
          absoluteCoverMaps_contemp$absBareGround_CONUS$hist,
          absoluteCoverMaps_contemp$absBareGround_CONUS$hist_future1, 
          absoluteCoverMaps_contemp$absBareGround_CONUS$hist_future2,
          ncol = 3,
          nrow = 2,
          heights = c(1,.35)
          ),
ggarrange(absoluteCoverMaps_contemp$absNLTree_CONUS$map, 
          absoluteCoverMaps_contemp$absNLTree_CONUS$map_future1,
          absoluteCoverMaps_contemp$absNLTree_CONUS$map_future2,
          absoluteCoverMaps_contemp$absNLTree_CONUS$hist,
          absoluteCoverMaps_contemp$absNLTree_CONUS$hist_future1, 
          absoluteCoverMaps_contemp$absNLTree_CONUS$hist_future2,
          ncol = 3,
          nrow = 2,
          heights = c(1,.35)
          ),
ggarrange(absoluteCoverMaps_contemp$absBLTree_CONUS$map, 
          absoluteCoverMaps_contemp$absBLTree_CONUS$map_future1,
          absoluteCoverMaps_contemp$absBLTree_CONUS$map_future2,
          absoluteCoverMaps_contemp$absBLTree_CONUS$hist,
          absoluteCoverMaps_contemp$absBLTree_CONUS$hist_future1, 
          absoluteCoverMaps_contemp$absBLTree_CONUS$hist_future2,
          ncol = 3,
          nrow = 2,
          heights = c(1,.35)
          ),
ggarrange(absoluteCoverMaps_contemp$absC3grass_CONUS$map, 
          absoluteCoverMaps_contemp$absC3grass_CONUS$map_future1,
          absoluteCoverMaps_contemp$absC3grass_CONUS$map_future2,
          absoluteCoverMaps_contemp$absC3grass_CONUS$hist,
          absoluteCoverMaps_contemp$absC3grass_CONUS$hist_future1, 
          absoluteCoverMaps_contemp$absC3grass_CONUS$hist_future2,
          ncol = 3,
          nrow = 2,
          heights = c(1,.35)
          ),
ggarrange(absoluteCoverMaps_contemp$absC4grass_CONUS$map, 
          absoluteCoverMaps_contemp$absC4grass_CONUS$map_future1,
          absoluteCoverMaps_contemp$absC4grass_CONUS$map_future2,
          absoluteCoverMaps_contemp$absC4grass_CONUS$hist,
          absoluteCoverMaps_contemp$absC4grass_CONUS$hist_future1, 
          absoluteCoverMaps_contemp$absC4grass_CONUS$hist_future2,
          ncol = 3,
          nrow = 2,
          heights = c(1,.35)
          ),
ggarrange(absoluteCoverMaps_contemp$absForb_CONUS$map, 
          absoluteCoverMaps_contemp$absForb_CONUS$map_future1,
          absoluteCoverMaps_contemp$absForb_CONUS$map_future2,
          absoluteCoverMaps_contemp$absForb_CONUS$hist,
          absoluteCoverMaps_contemp$absForb_CONUS$hist_future1, 
          absoluteCoverMaps_contemp$absForb_CONUS$hist_future2,
          ncol = 3,
          nrow = 2,
          heights = c(1,.35)
          ), 
ncol = 1
)
```

### Get predictions of absolute cover across time using observed climate/weather/soils data
```{r}
# get climate data from dayMet (d.f. is "climDatPred_unscaled")
climDat_time_unscaled <- climDat_time
names(climDat_time_unscaled)[c(5, 6, 7, 13, 10, 12, 99, 101, 102, 103)] <- c("T_warmestMonth_meanAnnAvg_CLIM", "T_coldestMonth_meanAnnAvg_CLIM", "precip_wettestMonth_meanAnnAvg_CLIM", "annWaterDeficit_meanAnnAvg_CLIM", "PrecipTempCorr_meanAnnAvg_CLIM", "isothermality_meanAnnAvg_CLIM", "soilDepth", "avgSandPerc_acrossDepth", "avgCoarsePerc_acrossDepth", "avgOrganicCarbonPerc_0_3cm")

# predict with contemporary climate data 
preds_byHand_time <- climDat_time_unscaled %>% 
  mutate(pred = 1/(1 + exp(-( 9.8726 + -0.2999*T_warmestMonth_meanAnnAvg_CLIM +  0.2456*T_coldestMonth_meanAnnAvg_CLIM +  0.0106*precip_wettestMonth_meanAnnAvg_CLIM + -0.0621*annWaterDeficit_meanAnnAvg_CLIM + -2.7863*PrecipTempCorr_meanAnnAvg_CLIM +  0.0540*isothermality_meanAnnAvg_CLIM + -0.0076*soilDepth +  0.0335*avgSandPerc_acrossDepth +  0.0310*avgCoarsePerc_acrossDepth +  0.2726*avgOrganicCarbonPerc_0_3cm))))
#predictionsModel <- predict(object = ecoMod, type = "response", newdata = climDatPred_unscaled)

## with contemporary climate data
totalHerb_F_predsOverTime <- makePredictions(predictionDF = climDat_time_Pred,
                                            modelObject = totalHerb_F) %>% 
  rename(absTotalHerb_F = "modelPreds")
totalHerb_GS_predsOverTime <- makePredictions(predictionDF = climDat_time_Pred,
                                            modelObject = totalHerb_GS) %>% 
  rename(absTotalHerb_GS = "modelPreds")

totalTree_F_predsOverTime<- makePredictions(predictionDF = climDat_time_Pred,
                                            modelObject = totalTree_F) %>% 
  rename(absTotalTree_F = "modelPreds")
totalTree_GS_predsOverTime<- makePredictions(predictionDF = climDat_time_Pred,
                                            modelObject = totalTree_GS) %>% 
  rename(absTotalTree_GS = "modelPreds")

bareGround_CONUS_predsOverTime<- makePredictions(predictionDF = climDat_time_Pred,
                                            modelObject = bareGround_CONUS) %>% 
  rename(absBareGround_CONUS = "modelPreds")

shrub_CONUS_predsOverTime<- makePredictions(predictionDF = climDat_time_Pred,
                                            modelObject = shrub_CONUS) %>% 
  rename(absShrub_CONUS = "modelPreds")

BLtree_F_predsOverTime<- makePredictions(predictionDF = climDat_time_Pred,
                                            modelObject = BLtree_F) %>% 
  rename(percBLTree_F = "modelPreds")
BLtree_GS_predsOverTime<- makePredictions(predictionDF = climDat_time_Pred,
                                            modelObject = BLtree_GS) %>% 
  rename(percBLTree_GS = "modelPreds")

NLtree_F_predsOverTime<- makePredictions(predictionDF = climDat_time_Pred,
                                            modelObject = NLtree_F) %>% 
  rename(percNLTree_F = "modelPreds")
NLtree_GS_predsOverTime<- makePredictions(predictionDF = climDat_time_Pred,
                                            modelObject = NLtree_GS) %>% 
  rename(percNLTree_GS = "modelPreds")

C3grass_CONUS_predsOverTime<- makePredictions(predictionDF = climDat_time_Pred,
                                            modelObject = C3grass_CONUS) %>% 
  rename(percC3grass_CONUS = "modelPreds")

C4grass_CONUS_predsOverTime<- makePredictions(predictionDF = climDat_time_Pred,
                                            modelObject = C4grass_CONUS) %>% 
  rename(percC4grass_CONUS = "modelPreds")

forb_CONUS_predsOverTime<- makePredictions(predictionDF = climDat_time_Pred,
                                            modelObject = forb_CONUS) %>% 
  rename(percForb_CONUS = "modelPreds")

predsOverTime <- totalHerb_F_predsOverTime  %>% 
  cbind(totalHerb_GS_predsOverTime %>% select(absTotalHerb_GS)) %>% 
  cbind(totalTree_F_predsOverTime %>% select(absTotalTree_F)) %>% 
  cbind(totalTree_GS_predsOverTime %>% select(absTotalTree_GS)) %>% 
  cbind(bareGround_CONUS_predsOverTime %>% select(absBareGround_CONUS)) %>% 
  cbind(shrub_CONUS_predsOverTime %>% select(absShrub_CONUS)) %>% 
  cbind(BLtree_F_predsOverTime %>% select(percBLTree_F)) %>% 
  cbind(BLtree_GS_predsOverTime %>% select(percBLTree_GS)) %>% 
  cbind(NLtree_F_predsOverTime %>% select(percNLTree_F)) %>% 
  cbind(NLtree_GS_predsOverTime %>% select(percNLTree_GS)) %>% 
  cbind(C3grass_CONUS_predsOverTime %>% select(percC3grass_CONUS)) %>% 
  cbind(C4grass_CONUS_predsOverTime %>% select(percC4grass_CONUS)) %>% 
  cbind(forb_CONUS_predsOverTime %>% select(percForb_CONUS)) %>% 
  cbind(preds_byHand_time %>% select(pred)) %>% 
  rename(prob_Forest = "pred") %>% 
  mutate(prob_grassShrub = 1 - prob_Forest)

## now, scale predictions according to ecoregion percentage
predsOverTime <- predsOverTime %>% 
  mutate(absTotalHerb_CONUS = (prob_grassShrub * absTotalHerb_GS) + (prob_Forest * absTotalHerb_F),
         absTotalTree_CONUS = (prob_grassShrub * absTotalTree_GS) + (prob_Forest * absTotalTree_F),
         percBLTree_CONUS = (prob_grassShrub * percBLTree_GS) + (prob_Forest * percBLTree_F),
         percNLTree_CONUS = (prob_grassShrub * percNLTree_GS) + (prob_Forest * percNLTree_F)
         )
## convert percentages into absolute cover for level 2 cover classes
predsOverTime <- predsOverTime %>% 
  mutate(absNLTree_CONUS = (percNLTree_CONUS * absTotalTree_CONUS), 
         absBLTree_CONUS = (percBLTree_CONUS * absTotalTree_CONUS), 
         absC3grass_CONUS = (percC3grass_CONUS * absTotalHerb_CONUS),
         absC4grass_CONUS = (percC4grass_CONUS * absTotalHerb_CONUS),
         absForb_CONUS = (percForb_CONUS * absTotalHerb_CONUS)
  )
```

### Now, visualize predictions of absolute cover over time
```{r}
# change spatialIDs to discrete numbers, since the long form is causing some sort of floating point issue? 
spatID_lu <- data.frame("spatialID" = unique(predsOverTime$spatialID), 
                        "uniqueID" = 1:length(predsOverTime$spatialID))
predsOverTime <- predsOverTime %>% 
  left_join(spatID_lu)

# make into a long format
predsOverTime_long <- predsOverTime %>% 
  select(year,x, y, spatialID, uniqueID, absShrub_CONUS, absBareGround_CONUS, absTotalHerb_CONUS, absTotalTree_CONUS, absNLTree_CONUS:absForb_CONUS) %>% 
  pivot_longer(cols = c(absShrub_CONUS, absBareGround_CONUS, absTotalHerb_CONUS, absTotalTree_CONUS, absNLTree_CONUS:absForb_CONUS)) %>% 
  mutate(year = as.integer(year))

# calculate the coefficient of variation for each cover type at each location
predsOverTime_cv <- predsOverTime_long %>% 
  group_by(uniqueID, name) %>% 
  summarize(cv = sd(value)/mean(value))
## add x,y 
predsOverTime_cv <- predsOverTime_cv %>% 
  left_join(predsOverTime %>% select(uniqueID, x, y))

# visualize change over time for a selection of points
predsOverTime_long %>% 
  filter(uniqueID %in% 1:50) %>% 
  filter(name %in% c("absShrub_CONUS", "absBareGround_CONUS",  "absNLTree_CONUS", 
                     "absBLTree_CONUS", "absC3grass_CONUS", "absC4grass_CONUS", "absForb_CONUS")) %>% 
  ggplot() + 
  facet_wrap(~uniqueID) + 
  geom_area(aes(x = year, y = value, fill = name)) + 
  geom_line(data = predsOverTime_long %>% 
              filter(uniqueID %in% 1:50) %>% 
              filter(name %in% c("absTotalHerb_CONUS", "absTotalTree_CONUS")),
            aes(x = year, y = value, linetype = name), col = "black") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90)) + 
  labs(title = "Change in modeled absolute cover by functional type from \n 2010 to 2020 for a subset of locations")

predsOverTime_cv %>%  
  ggplot() + 
  geom_boxplot(aes(x = name, y = cv, col = name)) +
  theme_minimal() + 
  labs(title = "Coefficients of variation of model-predicted absolute \n cover for each functional group from 2010-2020",
        x = "functional group",
       y = "coefficient of variation") +
  theme(axis.text.x = element_text(angle = 90))

  
```


## Now, relativize the predictions across the different functional groups
### First option: relativize cover so that cover for all groups sums to 1


### Second option: relativize cover so that cover for all groups *except* trees sums to 1
 
### Show "synthetic" predictions for first tier of cover models -- using *scaled* climate predictors
```{r fig.width = 10, fig.height=10}

## make the predictions scale according to ecoregion
preds_contemp <- preds_contemp %>% 
  mutate(totHerb_synth = ((prob_GrassShrub * predContemp_GS_totHerb) + (prob_forest * predContemp_F_totHerb)),
         totTree_synth = ((prob_GrassShrub * predContemp_GS_totTree) + (prob_forest * predContemp_F_totTree)))
preds_future_1 <- preds_future_1 %>% 
  mutate(totHerb_synth = ((prob_GrassShrub * predFuture1_GS_totHerb) + (prob_forest * predFuture1_F_totHerb)),
         totTree_synth = ((prob_GrassShrub * predFuture1_GS_totTree) + (prob_forest * predFuture1_F_totTree)))
preds_future_2 <- preds_future_2 %>% 
  mutate(totHerb_synth = ((prob_GrassShrub * predFuture2_GS_totHerb) + (prob_forest * predFuture2_F_totHerb)),
         totTree_synth = ((prob_GrassShrub * predFuture2_GS_totTree) + (prob_forest * predFuture2_F_totTree)))
## make the level 2 tree proportion scale according to ecoregion
# add ecoregion predictions to level 2 cover predictions

level2_cover_preds_contemp <- level2_cover_preds_contemp %>% 
  # select(-c(74:77)) %>% 
 cbind(preds_byHand %>% select(
   prob_forest, prob_GrassShrub)) %>% 
  mutate(needleLeavedTree_perc_scaled_synth = ((prob_GrassShrub * needleLeavedTree_grassShrub_percentage_scaled) + (prob_forest * needleLeavedTree_forest_percentage_scaled)), 
         broadLeavedTree_perc_scaled_synth = ((prob_GrassShrub * broadLeavedTree_grassShrub_percentage_scaled) + (prob_forest * broadLeavedTree_forest_percentage_scaled))) 
## but maybe need to scale to sum to 100 *after* multiplying by ecoregion probability?? this first pass is scaling **before** the multiplication -- it turns out that the multiplication works out either way...  this version, the synthetic values still sum to 100
# for future model 1
level2_cover_preds_future1 <- level2_cover_preds_future1 %>% 
  #select(-c(72:75)) %>% 
 cbind(preds_future1_byHand %>% select(
   prob_forest, prob_GrassShrub)) %>% 
  mutate(needleLeavedTree_perc_scaled_synth = ((prob_GrassShrub * needleLeavedTree_grassShrub_percentage_scaled) + (prob_forest * needleLeavedTree_forest_percentage_scaled)), 
         broadLeavedTree_perc_scaled_synth = ((prob_GrassShrub * broadLeavedTree_grassShrub_percentage_scaled) + (prob_forest * broadLeavedTree_forest_percentage_scaled))) 
# for future model 2
level2_cover_preds_future2 <- level2_cover_preds_future2 %>% 
 # select(-c(72:75)) %>% 
 cbind(preds_future2_byHand %>% select(
   prob_forest, prob_GrassShrub)) %>% 
  mutate(needleLeavedTree_perc_scaled_synth = ((prob_GrassShrub * needleLeavedTree_grassShrub_percentage_scaled) + (prob_forest * needleLeavedTree_forest_percentage_scaled)), 
         broadLeavedTree_perc_scaled_synth = ((prob_GrassShrub * broadLeavedTree_grassShrub_percentage_scaled) + (prob_forest * broadLeavedTree_forest_percentage_scaled))) 
```

```{r fig.width = 10, fig.height=10}
### make maps
## Plot predictions with contemporary data
# total Herbaceous
  # make into a raster
plotPreds_totHerbaceous <- preds_contemp %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "totHerb_synth", 
                   fun = mean, na.rm = TRUE)  

# get the extent of this particular raster, and crop it accordingly

plotPreds_totHerbaceous_2 <- plotPreds_totHerbaceous %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

map_preds_totHerbaceous <- ggplot() +
  geom_spatraster(data = plotPreds_totHerbaceous_2) + 
  #geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_2)),fill=NA ) +
labs(title = paste0("'Synthetic' prediction of total herbaceous cover with 
                    contemporary climate data")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObs_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_2)[c(2,4)])

# total Tree
  # make into a raster
plotPreds_totTree <- preds_contemp %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "totTree_synth", 
                   fun = mean, na.rm = TRUE)  
    
  

# get the extent of this particular raster, and crop it accordingly

plotPreds_totTree_2 <- plotPreds_totTree %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

map_preds_totTree <- ggplot() +
  geom_spatraster(data = plotPreds_totTree_2) + 
  #geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_2)),fill=NA ) +
labs(title = paste0("'Synthetic' prediction of total Tree cover with 
                    contemporary climate data")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObs_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_2)[c(2,4)])

## Plot predictions with future 1 data
# total Herbaceous
  # make into a raster
plotPreds_totHerbaceous_future1 <- preds_future_1 %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "totHerb_synth", 
                   fun = mean, na.rm = TRUE)  
    
  

# get the extent of this particular raster, and crop it accordingly

plotPreds_totHerbaceous_future1_2 <- plotPreds_totHerbaceous_future1 %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

plotPreds_totHerbaceous_future1_2 <- classify(plotPreds_totHerbaceous_future1_2, rcl = matrix(c(100, 1000, 100), ncol = 3))

map_preds_totHerbaceous_future1 <- ggplot() +
  geom_spatraster(data = plotPreds_totHerbaceous_future1_2) + 
  #geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_2)),fill=NA ) +
labs(title = paste0("'Synthetic' prediction of total herbaceous cover with 
                    future climate data - first model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObs_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_2)[c(2,4)])

# total Tree
  # make into a raster
plotPreds_totTree_future1 <- preds_future_1 %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "totTree_synth", 
                   fun = mean, na.rm = TRUE)  
    
  

# get the extent of this particular raster, and crop it accordingly

plotPreds_totTree_future1_2 <- plotPreds_totTree_future1 %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

plotPreds_totTree_future1_2 <- classify(plotPreds_totTree_future1_2, rcl = matrix(c(100, 1000, 100), ncol = 3))

map_preds_totTree_future1 <- ggplot() +
  geom_spatraster(data = plotPreds_totTree_future1_2) + 
  #geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_2)),fill=NA ) +
labs(title = paste0("'Synthetic' prediction of total Tree cover with 
                    future climate data - first model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObs_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_2)[c(2,4)])


## Plot predictions with future 1 data
# total Herbaceous
  # make into a raster
plotPreds_totHerbaceous_future2 <- preds_future_2 %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "totHerb_synth", 
                   fun = mean, na.rm = TRUE)  
    
  

# get the extent of this particular raster, and crop it accordingly

plotPreds_totHerbaceous_future2_2 <- plotPreds_totHerbaceous_future2 %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

plotPreds_totHerbaceous_future2_2 <- classify(plotPreds_totHerbaceous_future2_2, rcl = matrix(c(100, 1000, 100), ncol = 3))

map_preds_totHerbaceous_future2 <- ggplot() +
  geom_spatraster(data = plotPreds_totHerbaceous_future2_2) + 
  #geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_2)),fill=NA ) +
labs(title = paste0("'Synthetic' prediction of total herbaceous cover with 
                    future climate data - second model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObs_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_2)[c(2,4)])

# total Tree
  # make into a raster
plotPreds_totTree_future2 <- preds_future_2 %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "totTree_synth", 
                   fun = mean, na.rm = TRUE)  
    
  

# get the extent of this particular raster, and crop it accordingly

plotPreds_totTree_future2_2 <- plotPreds_totTree_future2 %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

plotPreds_totTree_future2_2 <- classify(plotPreds_totTree_future2_2, rcl = matrix(c(100, 1000, 100), ncol = 3))


map_preds_totTree_future2 <- ggplot() +
  geom_spatraster(data = plotPreds_totTree_future2_2) + 
 # geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_2)),fill=NA ) +
labs(title = paste0("'Synthetic' prediction of total Tree cover with 
                    future climate data - second model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObs_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_2)[c(2,4)])

ggarrange(map_preds_totHerbaceous, map_preds_totTree, 
          map_preds_totHerbaceous_future1, map_preds_totTree_future1, 
          map_preds_totHerbaceous_future2, map_preds_totTree_future2, ncol = 2, nrow = 3)
```

### Show "synthetic" predictions for the second tier of cover modelsat (i.e. predictions after they have been scaled to sum to 1 within each ecoregion, and then scaled again according to predicted ecoregion probability) (only for needle leaved/broad leaved trees, since other models are CONUS-wide)

```{r fig.width = 10, fig.height=10}
# broad leaved tree contemp
  # make into a raster
plotPreds_broadLeavedSynth_contemp <- level2_cover_preds_contemp %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "broadLeavedTree_perc_scaled_synth", 
                   fun = mean, na.rm = TRUE)

plotPreds_broadLeavedSynth_contemp_2 <- plotPreds_broadLeavedSynth_contemp %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

map_preds_broadLeavedSynth_contemp <- ggplot() +
  geom_spatraster(data = plotPreds_broadLeavedSynth_contemp_2) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_2)),fill=NA ) +
labs(title = paste0("'Synthetic' prediction of proportion of tree cover that is 
broad leaved with 
contemporary climate data")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObs_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_2)[c(2,4)])

# broad leaved tree future 1
  # make into a raster
plotPreds_broadLeavedSynth_future1 <- level2_cover_preds_future1 %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "broadLeavedTree_perc_scaled_synth", 
                   fun = mean, na.rm = TRUE)

plotPreds_broadLeavedSynth_future1_2 <- plotPreds_broadLeavedSynth_future1 %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

map_preds_broadLeavedSynth_future1 <- ggplot() +
  geom_spatraster(data = plotPreds_broadLeavedSynth_future1_2) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_2)),fill=NA ) +
labs(title = paste0("'Synthetic' prediction of proportion of tree cover that is 
broad leaved with 
future climate data - first model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObs_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_2)[c(2,4)])

# broad leaved tree future 2
  # make into a raster
plotPreds_broadLeavedSynth_future2 <- level2_cover_preds_future2 %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "broadLeavedTree_perc_scaled_synth", 
                   fun = mean, na.rm = TRUE)

plotPreds_broadLeavedSynth_future2_2 <- plotPreds_broadLeavedSynth_future2 %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

map_preds_broadLeavedSynth_future2 <- ggplot() +
  geom_spatraster(data = plotPreds_broadLeavedSynth_future2_2) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_2)),fill=NA ) +
labs(title = paste0("'Synthetic' prediction of proportion of tree cover that is 
broad leaved with 
future climate data - second model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObs_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_2)[c(2,4)])

# needle leaved tree contemp
  # make into a raster
plotPreds_needleLeavedSynth_contemp <- level2_cover_preds_contemp %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "needleLeavedTree_perc_scaled_synth", 
                   fun = mean, na.rm = TRUE)

plotPreds_needleLeavedSynth_contemp_2 <- plotPreds_needleLeavedSynth_contemp %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

map_preds_needleLeavedSynth_contemp <- ggplot() +
  geom_spatraster(data = plotPreds_needleLeavedSynth_contemp_2) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_2)),fill=NA ) +
labs(title = paste0("'Synthetic' prediction of proportion of tree cover that is 
needle leaved with 
contemporary climate data")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObs_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_2)[c(2,4)])

# needle leaved tree future 1
  # make into a raster
plotPreds_needleLeavedSynth_future1 <- level2_cover_preds_future1 %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "needleLeavedTree_perc_scaled_synth", 
                   fun = mean, na.rm = TRUE)

plotPreds_needleLeavedSynth_future1_2 <- plotPreds_needleLeavedSynth_future1 %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

map_preds_needleLeavedSynth_future1 <- ggplot() +
  geom_spatraster(data = plotPreds_needleLeavedSynth_future1_2) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_2)),fill=NA ) +
labs(title = paste0("'Synthetic' prediction of proportion of tree cover that is 
needle leaved with 
future climate data - first model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObs_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_2)[c(2,4)])

# needle leaved tree future 2
  # make into a raster
plotPreds_needleLeavedSynth_future2 <- level2_cover_preds_future2 %>% 
         #drop_na(paste(response)) %>% 
  #slice_sample(n = 5e4) %>%
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "needleLeavedTree_perc_scaled_synth", 
                   fun = mean, na.rm = TRUE)

plotPreds_needleLeavedSynth_future2_2 <- plotPreds_needleLeavedSynth_future2 %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])) 
       )

map_preds_needleLeavedSynth_future2 <- ggplot() +
  geom_spatraster(data = plotPreds_needleLeavedSynth_future2_2) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObs_2)),fill=NA ) +
labs(title = paste0("'Synthetic' prediction of proportion of tree cover that is 
needle leaved with 
future climate data - second model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObs_2)[c(1,3)]) + 
  ylim(st_bbox(plotObs_2)[c(2,4)])

ggarrange(map_preds_broadLeavedSynth_contemp, map_preds_needleLeavedSynth_contemp, 
          map_preds_broadLeavedSynth_future1, map_preds_needleLeavedSynth_future1, 
          map_preds_broadLeavedSynth_future2, map_preds_needleLeavedSynth_future2, ncol = 2, nrow = 3)
```

### Now, scale all of the first tier of cover models to sum to 100% 
```{r fig.width = 15, fig.height=12}
## contemporary climate data
preds_contemp <- preds_contemp %>% 
  mutate(totalCover =  predContemp_CONUS_shrub + predContemp_CONUS_bareGround + totHerb_synth + totTree_synth)  %>% # calculate total cover "%" in a location
  # scale so that the cover classes sum to 100 
  mutate(shrub_cover_finalScaled = predContemp_CONUS_shrub/totalCover #* 100
  ,
         bareGround_cover_finalScaled = predContemp_CONUS_bareGround/totalCover #* 100
         , 
         totalHerb_cover_finalScaled = totHerb_synth/totalCover# * 100
  , 
         totalTree_cover_finalScaled = totTree_synth/totalCover #* 100
         )

## future climate data model 1
preds_future_1 <- preds_future_1 %>% 
  mutate(totalCover =  predFuture1_CONUS_shrub + predFuture1_CONUS_bareGround + totHerb_synth + totTree_synth)  %>% # calculate total cover "%" in a location
  # scale so that the cover classes sum to 100 
  mutate(shrub_cover_finalScaled = predFuture1_CONUS_shrub/totalCover #* 100
  ,
         bareGround_cover_finalScaled = predFuture1_CONUS_bareGround/totalCover #* 100
         , 
         totalHerb_cover_finalScaled = totHerb_synth/totalCover #* 100
         , 
         totalTree_cover_finalScaled = totTree_synth/totalCover #* 100
         )

## future climate data model 2
preds_future_2 <- preds_future_2 %>% 
  mutate(totalCover = predFuture2_CONUS_shrub + predFuture2_CONUS_bareGround + totHerb_synth + totTree_synth)  %>% # calculate total cover "%" in a location
  # scale so that the cover classes sum to 100 
  mutate(shrub_cover_finalScaled = predFuture2_CONUS_shrub/totalCover #* 100
  ,
         bareGround_cover_finalScaled = predFuture2_CONUS_bareGround/totalCover #* 100
         , 
         totalHerb_cover_finalScaled = totHerb_synth/totalCover #* 100
         , 
         totalTree_cover_finalScaled = totTree_synth/totalCover #* 100
         )

### make figures
# for contemporary climate 
contempScaledPreds_maps <- map(c("shrub_cover_finalScaled",
         "bareGround_cover_finalScaled",  "totalHerb_cover_finalScaled", 
         "totalTree_cover_finalScaled"), .f = function(x) {
           # make the raster
           rast_1 <- preds_contemp %>% 
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = x, 
                   fun = mean, na.rm = TRUE) %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])))
           
           # make map 
           map_1  <- ggplot() +
  geom_spatraster(data = rast_1) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("'Scaled' prediction of ", x, " with 
                    contemporary climate data")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(rast_1)[c(1,3)]) + 
  ylim(st_bbox(rast_1)[c(2,4)])
           
           return(list("rast" = rast_1, "map" = map_1))
         }
         )
names(contempScaledPreds_maps) <- c("shrub_cover_finalScaled",
         "bareGround_cover_finalScaled",  "totalHerb_cover_finalScaled", 
         "totalTree_cover_finalScaled")

# for future climate model 1
future1ScaledPreds_maps <- map(c("shrub_cover_finalScaled",
         "bareGround_cover_finalScaled",  "totalHerb_cover_finalScaled", 
         "totalTree_cover_finalScaled"), .f = function(x) {
           # make the raster
           rast_1 <- preds_future_1 %>% 
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = x, 
                   fun = mean, na.rm = TRUE) %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])))
           
           # make map 
           map_1  <- ggplot() +
  geom_spatraster(data = rast_1) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("'Scaled' prediction of ", x, " with 
                    contemporary climate data")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(rast_1)[c(1,3)]) + 
  ylim(st_bbox(rast_1)[c(2,4)])
           
           return(list("rast" = rast_1, "map" = map_1))
         }
         )

names(future1ScaledPreds_maps) <- c("shrub_cover_finalScaled",
         "bareGround_cover_finalScaled",  "totalHerb_cover_finalScaled", 
         "totalTree_cover_finalScaled")

# for future climate model 2
future2ScaledPreds_maps <- map(c("shrub_cover_finalScaled",
         "bareGround_cover_finalScaled",  "totalHerb_cover_finalScaled", 
         "totalTree_cover_finalScaled"), .f = function(x) {
           # make the raster
           rast_1 <- preds_future_2 %>% 
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = x, 
                   fun = mean, na.rm = TRUE) %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])))
           
           # make map 
           map_1  <- ggplot() +
  geom_spatraster(data = rast_1) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("'Scaled' prediction of ", x, " with 
                    contemporary climate data")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(rast_1)[c(1,3)]) + 
  ylim(st_bbox(rast_1)[c(2,4)])
           
           return(list("rast" = rast_1, "map" = map_1))
         }
         )
names(future2ScaledPreds_maps) <- c("shrub_cover_finalScaled",
         "bareGround_cover_finalScaled",  "totalHerb_cover_finalScaled", 
         "totalTree_cover_finalScaled")


# ggarrange(contempScaledPreds_maps[[3]], contempScaledPreds_maps[[4]], contempScaledPreds_maps[[1]], contempScaledPreds_maps[[2]], common.legend = TRUE, ncol = 2, nrow = 2, legend = "bottom")  %>% 
#   annotate_figure(fig.lab = "Scaled model predictions of 'level 1' cover variables with contemporary data ", fig.lab.size = 20)
# 
# 
# ggarrange(future1ScaledPreds_maps[[3]], future1ScaledPreds_maps[[4]], future1ScaledPreds_maps[[1]], future1ScaledPreds_maps[[2]], common.legend = TRUE, ncol = 2, nrow = 2, legend = "bottom")  %>% 
#   annotate_figure(fig.lab = "Scaled model predictions of 'level 1' cover variables with future climate data - model 1", fig.lab.size = 20)
# 
# 
# ggarrange(future2ScaledPreds_maps[[3]], future2ScaledPreds_maps[[4]], future2ScaledPreds_maps[[1]], future2ScaledPreds_maps[[2]], common.legend = TRUE, ncol = 2, nrow = 2, legend = "bottom")  %>% 
#   annotate_figure(fig.lab = "Scaled model predictions of 'level 1' cover variables with future climate data - model 2", fig.lab.size = 20)
  
```

### Add in second tier of cover models to break up total herbaceous cover into C3/C4/Forb and total tree cover into broad-leaved tree/needle-leaved tree

```{r fig.width = 15, fig.height=12}
## for contemporary data, multiply the synthetic and scaled level-1 cover predictions by the scaled level-2 percentages
preds_contemp  <- preds_contemp  %>% 
  left_join(level2_cover_preds_contemp) %>% 
 mutate(C3_cover_finalScaled = totalHerb_cover_finalScaled *(C3_percentage_scaled#/100
                                                             ),
        C4_cover_finalScaled = totalHerb_cover_finalScaled *(C4_percentage_scaled#/100
                                                             ),
        forb_cover_finalScaled = totalHerb_cover_finalScaled *(forb_percentage_scaled#/100
                                                               ),
        broadLeaved_cover_finalScaled = totalTree_cover_finalScaled *(broadLeavedTree_perc_scaled_synth#/100
                                                                      ),
        needleLeaved_cover_finalScaled = totalTree_cover_finalScaled *(needleLeavedTree_perc_scaled_synth#/100
                                                                       )) 

## for future 1 data, multiply the synthetic and scaled level-1 cover predictions by the scaled level-2 percentages
preds_future_1 <- preds_future_1 %>% 
  left_join(level2_cover_preds_future1) %>% 
 mutate(C3_cover_finalScaled = totalHerb_cover_finalScaled *(C3_percentage_scaled),
        C4_cover_finalScaled = totalHerb_cover_finalScaled *(C4_percentage_scaled),
        forb_cover_finalScaled = totalHerb_cover_finalScaled *(forb_percentage_scaled),
        broadLeaved_cover_finalScaled = totalTree_cover_finalScaled *(broadLeavedTree_perc_scaled_synth),
        needleLeaved_cover_finalScaled = totalTree_cover_finalScaled *(needleLeavedTree_perc_scaled_synth)) 

## for future 2 data, multiply the synthetic and scaled level-1 cover predictions by the scaled level-2 percentages
preds_future_2 <- preds_future_2 %>% 
  left_join(level2_cover_preds_future2) %>% 
 mutate(C3_cover_finalScaled = totalHerb_cover_finalScaled *(C3_percentage_scaled),
        C4_cover_finalScaled = totalHerb_cover_finalScaled *(C4_percentage_scaled),
        forb_cover_finalScaled = totalHerb_cover_finalScaled *(forb_percentage_scaled),
        broadLeaved_cover_finalScaled = totalTree_cover_finalScaled *(broadLeavedTree_perc_scaled_synth),
        needleLeaved_cover_finalScaled = totalTree_cover_finalScaled *(needleLeavedTree_perc_scaled_synth)) 


# make maps for level 2 cover w/ contemporary climate data
contemp_cover2_ScaledPreds_maps <- map(c("C3_cover_finalScaled",
         "C4_cover_finalScaled",  "forb_cover_finalScaled", 
         "broadLeaved_cover_finalScaled", "needleLeaved_cover_finalScaled"), .f = function(x) {
           # make the raster
           rast_1 <- preds_contemp %>% 
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = x, 
                   fun = mean, na.rm = TRUE) %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])))
           
           # make map 
           map_1  <- ggplot() +
  geom_spatraster(data = rast_1) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("'Scaled' prediction of ", x, " with 
                    contemporary climate data")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(rast_1)[c(1,3)]) + 
  ylim(st_bbox(rast_1)[c(2,4)])
           
           return(list("rast" = rast_1, "map" = map_1))
         }
         )
names(contemp_cover2_ScaledPreds_maps) <- c("C3_cover_finalScaled",
         "C4_cover_finalScaled",  "forb_cover_finalScaled", 
         "broadLeaved_cover_finalScaled", "needleLeaved_cover_finalScaled")

# make maps for level 2 cover w/ future 1 climate data
future1_cover2_ScaledPreds_maps <- map(c("C3_cover_finalScaled",
         "C4_cover_finalScaled",  "forb_cover_finalScaled", 
         "broadLeaved_cover_finalScaled", "needleLeaved_cover_finalScaled"), .f = function(x) {
           # make the raster
           rast_1 <- preds_future_1 %>% 
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = x, 
                   fun = mean, na.rm = TRUE) %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])))
           
           # make map 
           map_1  <- ggplot() +
  geom_spatraster(data = rast_1) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("'Scaled' prediction of ", x, " with 
                    future climate data from model 1")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(rast_1)[c(1,3)]) + 
  ylim(st_bbox(rast_1)[c(2,4)])
           
           return(list("rast" = rast_1, "map" = map_1))
         }
         )
names(future1_cover2_ScaledPreds_maps) <- c("C3_cover_finalScaled",
         "C4_cover_finalScaled",  "forb_cover_finalScaled", 
         "broadLeaved_cover_finalScaled", "needleLeaved_cover_finalScaled")

# make maps for level 2 cover w/ future 2 climate data
future2_cover2_ScaledPreds_maps <- map(c("C3_cover_finalScaled",
         "C4_cover_finalScaled",  "forb_cover_finalScaled", 
         "broadLeaved_cover_finalScaled", "needleLeaved_cover_finalScaled"), .f = function(x) {
           # make the raster
           rast_1 <- preds_future_2 %>% 
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = x, 
                   fun = mean, na.rm = TRUE) %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])))
           
           # make map 
           map_1  <- ggplot() +
  geom_spatraster(data = rast_1) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("'Scaled' prediction of ", x, " with 
                    future climate data from model 2")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(rast_1)[c(1,3)]) + 
  ylim(st_bbox(rast_1)[c(2,4)])
           
           return(list("rast" = rast_1, "map" = map_1))
         }
         )


names(future2_cover2_ScaledPreds_maps) <- c("C3_cover_finalScaled",
         "C4_cover_finalScaled",  "forb_cover_finalScaled", 
         "broadLeaved_cover_finalScaled", "needleLeaved_cover_finalScaled")


## save "preds_contemp" data, since that has the sythetic but not scaled data (predictions that are weighted according ecoregion prediction, but not scaled to sum to 100 w/in each gridcell) 
saveRDS(preds_contemp, "../../../Data_processed/CoverData/ModelPredictionData/ModelPreds_UNRELATIVIZED_ContempClimateData_dayMetScale.rds")


```


### Figures of final, scaled, 'level 1' cover classes with contemporary climate data 

```{r fig.width=18, fig.height=18}

# make maps of residuals between scaled predictions and observations
shrubCover_resids_final <- contempScaledPreds_maps[[1]]$rast - plotObservations_CONUS_shrub_2 
bareGround_resids_final <- contempScaledPreds_maps[[2]]$rast - plotObservations_CONUS_bareGround_2 
totalHerb_resids_final <- contempScaledPreds_maps[[3]]$rast - plotObservations_F_totHerb_2 #(plotObservations_F_totHerb_2 is the observed total herbaceous cover)
totalTree_resids_final <- contempScaledPreds_maps[[4]]$rast - plotObservations_F_totTree_2 #(plotObservations_F_totHerb_2 is the observed total herbaceous cover)

mapResids_final_shrubCover <- ggplot() +
  geom_spatraster(data = shrubCover_resids_final) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(shrubCover_resids_final)),fill=NA ) +
labs(title = paste0("Residuals (scaled final model prediction - observations) for 
                    predicted shrub cover (scaled and relativized)")) +
  scale_fill_gradient2(low = "red",
                       mid = "white" ,
                       high = "blue" , 
                       midpoint = 0,   na.value = "grey20",
                       limits = c(-1,1)
                       )  + 
  xlim(st_bbox(shrubCover_resids_final)[c(1,3)]) + 
  ylim(st_bbox(shrubCover_resids_final)[c(2,4)])

mapResids_final_bareGround <- ggplot() +
  geom_spatraster(data = bareGround_resids_final) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(bareGround_resids_final)),fill=NA ) +
labs(title = paste0("Residuals (scaled final model prediction - observations) for 
                    predicted bare ground cover (scaled and relativized)")) +
  scale_fill_gradient2(low = "red",
                       mid = "white" ,
                       high = "blue" , 
                       midpoint = 0,   na.value = "grey20",
                       limits = c(-1,1)
                       )  + 
  xlim(st_bbox(bareGround_resids_final)[c(1,3)]) + 
  ylim(st_bbox(bareGround_resids_final)[c(2,4)])

mapResids_final_totalHerb <- ggplot() +
  geom_spatraster(data = totalHerb_resids_final) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(totalHerb_resids_final)),fill=NA ) +
labs(title = paste0("Residuals (scaled final model prediction - observations) for 
                    predicted total herbaceous cover (scaled and relativized)")) +
  scale_fill_gradient2(low = "red",
                       mid = "white" ,
                       high = "blue" , 
                       midpoint = 0,   na.value = "grey20",
                       limits = c(-1,1)
                       )  + 
  xlim(st_bbox(totalHerb_resids_final)[c(1,3)]) + 
  ylim(st_bbox(totalHerb_resids_final)[c(2,4)])

mapResids_final_totalTree <- ggplot() +
  geom_spatraster(data = totalTree_resids_final) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(totalTree_resids_final)),fill=NA ) +
labs(title = paste0("Residuals (scaled final model prediction - observations) for 
                    predicted total tree cover (scaled and relativized)")) +
  scale_fill_gradient2(low = "red",
                       mid = "white" ,
                       high = "blue" , 
                       midpoint = 0,   na.value = "grey20",
                       limits = c(-1,1)
                       )  + 
  xlim(st_bbox(totalTree_resids_final)[c(1,3)]) + 
  ylim(st_bbox(totalTree_resids_final)[c(2,4)])


## level 1 cover variables
ggarrange( contempScaledPreds_maps[[3]]$map, map_obs_F_totHerb, mapResids_final_totalHerb,
           contempScaledPreds_maps[[4]]$map,  map_obs_F_totTree, mapResids_final_totalTree,
           contempScaledPreds_maps[[1]]$map, map_obs_CONUS_shrub, mapResids_final_shrubCover,
           contempScaledPreds_maps[[2]]$map, map_obs_CONUS_bareGround, mapResids_final_bareGround,
  ncol = 3, nrow = 4
  ) %>% 
  annotate_figure(fig.lab = "Final scaled and Relativized predictions, observations, and residuals for 'level 1' cover classes with contemporary climate data", fig.lab.size = 20)


```


### Figures of final, scaled, 'level 2' cover classes with contemporary climate data 

```{r fig.width=18, fig.height=22}
## level 2 cover variables

# calculate the actual observed cover (rather than proportion) for level 2 cover
plotObservations_C3_actualCover <-  plotObservations_F_totHerb_2 * (plotObservations_C3_proportion_2)
plotObservations_C4_actualCover <-  plotObservations_F_totHerb_2 * (plotObservations_C4_proportion_2)
plotObservations_forb_actualCover <-  plotObservations_F_totHerb_2 * (plotObservations_forb_proportion_2)
plotObservations_broadLeaved_actualCover <-  plotObservations_F_totTree_2 * (plotObservations_broadLeaved_forest_proportion_2)
plotObservations_needleLeaved_actualCover <-  plotObservations_F_totTree_2 * (plotObservations_needleLeaved_proportion_2)

# make maps of observations (not proportion, but actual values)
map_obs_C3_actualCover <-  ggplot() +
  geom_spatraster(data = plotObservations_C3_actualCover) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObservations_C3_actualCover)),fill=NA ) +
labs(title = paste0("Observations of actual cover - C3 graminoids")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObservations_C3_actualCover)[c(1,3)]) + 
  ylim(st_bbox(plotObservations_C3_actualCover)[c(2,4)])

map_obs_C4_actualCover <-  ggplot() +
  geom_spatraster(data = plotObservations_C4_actualCover) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObservations_C4_actualCover)),fill=NA ) +
labs(title = paste0("Observations of actual cover - C4 graminoids")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObservations_C4_actualCover)[c(1,3)]) + 
  ylim(st_bbox(plotObservations_C4_actualCover)[c(2,4)])

map_obs_forb_actualCover <-  ggplot() +
  geom_spatraster(data = plotObservations_forb_actualCover) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObservations_forb_actualCover)),fill=NA ) +
labs(title = paste0("Observations of actual cover - forbs")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObservations_forb_actualCover)[c(1,3)]) + 
  ylim(st_bbox(plotObservations_forb_actualCover)[c(2,4)])

map_obs_broadLeaved_actualCover <-  ggplot() +
  geom_spatraster(data = plotObservations_broadLeaved_actualCover) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObservations_broadLeaved_actualCover)),fill=NA ) +
labs(title = paste0("Observations of actual cover - broadLeaved trees")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObservations_broadLeaved_actualCover)[c(1,3)]) + 
  ylim(st_bbox(plotObservations_broadLeaved_actualCover)[c(2,4)])

map_obs_needleLeaved_actualCover <-  ggplot() +
  geom_spatraster(data = plotObservations_needleLeaved_actualCover) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(plotObservations_needleLeaved_actualCover)),fill=NA ) +
labs(title = paste0("Observations of actual cover - needleLeaved trees")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(st_bbox(plotObservations_needleLeaved_actualCover)[c(1,3)]) + 
  ylim(st_bbox(plotObservations_needleLeaved_actualCover)[c(2,4)])


# make maps of residuals between scaled predictions and observations
C3Cover_resids_final <- contemp_cover2_ScaledPreds_maps[[1]]$rast - plotObservations_C3_actualCover 
C4Cover_resids_final <- contemp_cover2_ScaledPreds_maps[[2]]$rast - plotObservations_C4_actualCover 
forb_resids_final <- contemp_cover2_ScaledPreds_maps[[3]]$rast - plotObservations_forb_actualCover
broadLeaved_resids_final <- contemp_cover2_ScaledPreds_maps[[4]]$rast - plotObservations_broadLeaved_actualCover
needleLeaved_resids_final <- contemp_cover2_ScaledPreds_maps[[4]]$rast - plotObservations_needleLeaved_actualCover

mapResids_final_C3 <- ggplot() +
  geom_spatraster(data = C3Cover_resids_final) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(C3Cover_resids_final)),fill=NA ) +
labs(title = paste0("Residuals (scaled final model prediction - observations) for 
                    predicted C3 graminoid cover (scaled and relativized)")) +
  scale_fill_gradient2(low = "red",
                       mid = "white" ,
                       high = "blue" , 
                       midpoint = 0,   na.value = "grey20",
                       limits = c(-1,1)
                       )  + 
  xlim(st_bbox(C3Cover_resids_final)[c(1,3)]) + 
  ylim(st_bbox(C3Cover_resids_final)[c(2,4)])

mapResids_final_C4 <- ggplot() +
  geom_spatraster(data = C4Cover_resids_final) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(C4Cover_resids_final)),fill=NA ) +
labs(title = paste0("Residuals (scaled final model prediction - observations) for 
                    predicted C4 graminoid cover (scaled and relativized)")) +
  scale_fill_gradient2(low = "red",
                       mid = "white" ,
                       high = "blue" , 
                       midpoint = 0,   na.value = "grey20",
                       limits = c(-1,1)
                       )  + 
  xlim(st_bbox(C4Cover_resids_final)[c(1,3)]) + 
  ylim(st_bbox(C4Cover_resids_final)[c(2,4)])

mapResids_final_forb <- ggplot() +
  geom_spatraster(data = forb_resids_final) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(forb_resids_final)),fill=NA ) +
labs(title = paste0("Residuals (scaled final model prediction - observations) for 
                    predicted forb cover (scaled and relativized)")) +
  scale_fill_gradient2(low = "red",
                       mid = "white" ,
                       high = "blue" , 
                       midpoint = 0,   na.value = "grey20",
                       limits = c(-1,1)
                       )  + 
  xlim(st_bbox(forb_resids_final)[c(1,3)]) + 
  ylim(st_bbox(forb_resids_final)[c(2,4)])

mapResids_final_broadLeaved <- ggplot() +
  geom_spatraster(data = broadLeaved_resids_final) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(broadLeaved_resids_final)),fill=NA ) +
labs(title = paste0("Residuals (scaled final model prediction - observations) for 
                    predicted broad leaved tree cover (scaled and relativized)")) +
  scale_fill_gradient2(low = "red",
                       mid = "white" ,
                       high = "blue" , 
                       midpoint = 0,   na.value = "grey20",
                       limits = c(-1,1)
                       )  + 
  xlim(st_bbox(broadLeaved_resids_final)[c(1,3)]) + 
  ylim(st_bbox(broadLeaved_resids_final)[c(2,4)])

mapResids_final_needleLeaved <- ggplot() +
  geom_spatraster(data = needleLeaved_resids_final) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(needleLeaved_resids_final)),fill=NA ) +
labs(title = paste0("Residuals (scaled final model prediction - observations) for 
                    predicted needle leaved tree cover (scaled and relativized)")) +
  scale_fill_gradient2(low = "red",
                       mid = "white" ,
                       high = "blue" , 
                       midpoint = 0,   na.value = "grey20",
                       limits = c(-1,1)
                       )  + 
  xlim(st_bbox(needleLeaved_resids_final)[c(1,3)]) + 
  ylim(st_bbox(needleLeaved_resids_final)[c(2,4)])

## level 1 cover variables
ggarrange(contemp_cover2_ScaledPreds_maps[[1]]$map, map_obs_C3_actualCover, mapResids_final_C3,
          contemp_cover2_ScaledPreds_maps[[2]]$map, map_obs_C4_actualCover, mapResids_final_C4,
          contemp_cover2_ScaledPreds_maps[[3]]$map, map_obs_forb_actualCover, mapResids_final_forb,
          contemp_cover2_ScaledPreds_maps[[4]]$map, map_obs_broadLeaved_actualCover, mapResids_final_broadLeaved,
          contemp_cover2_ScaledPreds_maps[[5]]$map, map_obs_needleLeaved_actualCover, mapResids_final_needleLeaved,
  ncol = 3, nrow = 5)%>% 
  annotate_figure(fig.lab = "Final scaled and Relativized predictions, observations, and residuals for 'level 2' cover classes with contemporary climate data", fig.lab.size = 20)

```

## Finally, make a map of total cover (the summed predicted cover of total trees, total herbaceous, shrubs, and bare ground, prior to scaling)
```{r}
rast_1 <- preds_contemp %>% 
  terra::vect(geom = c("x", "y")) %>% 
  terra::set.crs(crs(test_rast)) %>% 
  terra::rasterize(y = test_rast, 
                   field = "totalCover", 
                   fun = mean, na.rm = TRUE) %>% 
  crop(ext(min(tempExt[,1]), max(tempExt[,1]),
           min(tempExt[,2]), max(tempExt[,2])))
           
           # make map 
           (map_totalCover  <- ggplot() +
  geom_spatraster(data = rast_1) + 
  geom_sf(data = mapRegions, fill = NA, col = "orchid", lwd = .5) +
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("Total, unscaled cover with 
                    contemporary climate data")) +
  scale_fill_gradient2(low = "white",
                       high = "purple" , 
                       #midpoint = 0, 
                       limits = c(0,3),  
                       na.value = "lightgrey") + 
  xlim(st_bbox(rast_1)[c(1,3)]) + 
  ylim(st_bbox(rast_1)[c(2,4)]))
           
```

## compare prediction of level 1, relativized cover to cover from former SOILWAT version, but only within the sagebrush biome 
```{r fig.width=18, fig.height=22}
## read in data from Daniel w/ former SOILWAT output 
bareGroundCover_ds <- terra::rast("../../../Data_raw/vegCoverOutputFromDaniel_sagebrushBiome/veg_SageGrouseClimate-MACAv2.nc", 
                                      drivers = "NETCDF", 
                                      subds = "fcover_bg"
                                      ) %>% 
  terra::project(test_rast) %>% 
  resample(test_rast) %>% 
  crop(contempScaledPreds_maps[[3]]$rast)

forbCover_ds <- terra::rast("../../../Data_raw/vegCoverOutputFromDaniel_sagebrushBiome/veg_SageGrouseClimate-MACAv2.nc", 
                                      drivers = "NETCDF", 
                                      subds = "fcover_forbs"
                                      )%>% 
  terra::project(test_rast)%>% 
  resample(test_rast) %>% 
  crop(contempScaledPreds_maps[[3]]$rast)

grassCover_ds <- terra::rast("../../../Data_raw/vegCoverOutputFromDaniel_sagebrushBiome/veg_SageGrouseClimate-MACAv2.nc", 
                                      drivers = "NETCDF", 
                                      subds = "fcover_grasses"
                                      )%>% 
  terra::project(test_rast)%>% 
  resample(test_rast) %>% 
  crop(contempScaledPreds_maps[[3]]$rast)

shrubsCover_ds <- terra::rast("../../../Data_raw/vegCoverOutputFromDaniel_sagebrushBiome/veg_SageGrouseClimate-MACAv2.nc", 
                                      drivers = "NETCDF", 
                                      subds = "fcover_shrubs"
                                      )%>% 
  terra::project(test_rast) %>% 
  resample(test_rast) %>% 
  crop(contempScaledPreds_maps[[3]]$rast)

treeCover_ds <- terra::rast("../../../Data_raw/vegCoverOutputFromDaniel_sagebrushBiome/veg_SageGrouseClimate-MACAv2.nc", 
                                      drivers = "NETCDF", 
                                      subds = "fcover_trees"
                                      )%>% 
  terra::project(test_rast) %>% 
  resample(test_rast) %>% 
  crop(contempScaledPreds_maps[[3]]$rast)


## now, compare the projected values from this dataset to the values we predicted. 
# contemporary predictions from my models 
# total herb
#contempScaledPreds_maps[[3]]$rast
# total tree
#contempScaledPreds_maps[[4]]$rast
# shrub
#contempScaledPreds_maps[[1]]$rast
# bare ground
#contempScaledPreds_maps[[2]]$rast
## use the data from Daniel as a mask to trim my model outputs to the sagebrush biome
totHerb_as <- 
contempScaledPreds_maps[[3]]$rast %>% 
  crop(y = treeCover_ds, mask = TRUE)

totTree_as <- 
contempScaledPreds_maps[[4]]$rast %>% 
  crop(y = treeCover_ds, mask = TRUE)

shrub_as <- 
contempScaledPreds_maps[[1]]$rast %>% 
  crop(y = treeCover_ds, mask = TRUE)

bareGround_as <- 
contempScaledPreds_maps[[2]]$rast %>% 
  crop(y = treeCover_ds, mask = TRUE)

# plot shrub preds from my model vs old SOILWAT output
shrubMap_as <- ggplot() +
  geom_spatraster(data = shrub_as) + 
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("Final shrub fractional cover from our current model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(c(-1956750, 3250)) + 
  ylim(c(-883500, 952500))
shrubMap_ds <- ggplot() +
  geom_spatraster(data = shrubsCover_ds#*100
  ) + 
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("Final shrub fractional cover from previous SOILWAT run")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(c(-1956750, 3250)) + 
  ylim(c(-883500, 952500))
shrubCompareMap <- ggplot() +
  geom_spatraster(data = shrub_as - shrubsCover_ds#*100
  ) + 
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("diffs: current model Shrub preds - previous SOILWAT preds")) +
  scale_fill_gradient2(low = "red",
                       mid = "white" ,
                       high = "blue" , 
                       midpoint = 0, limits = c(-1,1),  na.value = "lightgrey") + 
  xlim(c(-1956750, 3250)) + 
  ylim(c(-883500, 952500))

# plot tree preds from my model vs old SOILWAT output
treeMap_as <- ggplot() +
  geom_spatraster(data = totTree_as) + 
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("Final tree fractional cover from our current model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(c(-1956750, 3250)) + 
  ylim(c(-883500, 952500))
treeMap_ds <- ggplot() +
    geom_spatraster(data = treeCover_ds#*100
    ) + 
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("Final tree fractional cover from previous SOILWAT run")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(c(-1956750, 3250)) + 
  ylim(c(-883500, 952500))
treeCompareMap <- ggplot() +
  geom_spatraster(data = totTree_as - treeCover_ds#*100
  ) + 
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("diffs: current model tree preds - previous SOILWAT preds")) +
  scale_fill_gradient2(low = "red",
                       mid = "white" ,
                       high = "blue" , 
                       midpoint = 0, limits = c(-1,1),  na.value = "lightgrey") + 
  xlim(c(-1956750, 3250)) + 
  ylim(c(-883500, 952500))

# plot herbaceous preds from my model vs old SOILWAT output
herbMap_as <- ggplot() +
  geom_spatraster(data = totHerb_as) + 
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("Final total herbaceous fractional cover from our current model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(c(-1956750, 3250)) + 
  ylim(c(-883500, 952500))
herbMap_ds <- ggplot() +
    geom_spatraster(data = (grassCover_ds + forbCover_ds)#*100
    ) + 
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("Final herbaceous fractional cover from previous SOILWAT run")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(c(-1956750, 3250)) + 
  ylim(c(-883500, 952500))
herbCompareMap <- ggplot() +
  geom_spatraster(data = totHerb_as - (grassCover_ds + forbCover_ds)#*100
  ) + 
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("diffs: current model herbaceous preds - previous SOILWAT preds")) +
  scale_fill_gradient2(low = "red",
                       mid = "white" ,
                       high = "blue" , 
                       midpoint = 0, limits = c(-1,1),  na.value = "lightgrey") + 
  xlim(c(-1956750, 3250)) + 
  ylim(c(-883500, 952500))

# plot bare ground preds from my model vs old SOILWAT output
bareGroundMap_as <- ggplot() +
  geom_spatraster(data = bareGround_as) + 
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("Final total bare ground fractional cover from our current model")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(c(-1956750, 3250)) + 
  ylim(c(-883500, 952500))
bareGroundMap_ds <- ggplot() +
    geom_spatraster(data = (bareGroundCover_ds)#*100
    ) + 
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("Final herbaceous fractional cover from previous SOILWAT run")) +
  scale_fill_gradient2(low = "brown",
                       mid = "wheat" ,
                       high = "darkgreen" , 
                       midpoint = 0, limits = c(0,1),  na.value = "lightgrey") + 
  xlim(c(-1956750, 3250)) + 
  ylim(c(-883500, 952500))
bareGroundCompareMap <- ggplot() +
  geom_spatraster(data = bareGround_as - (bareGroundCover_ds)#*100
  ) + 
  geom_sf(data=cropped_states %>% st_transform(crs = st_crs(test_rast)) %>% st_crop(st_bbox(rast_1)),fill=NA ) +
labs(title = paste0("diffs: current model bare ground preds - previous SOILWAT preds")) +
  scale_fill_gradient2(low = "red",
                       mid = "white" ,
                       high = "blue" , 
                       midpoint = 0, limits = c(-1,1),  na.value = "lightgrey") + 
  xlim(c(-1956750, 3250)) + 
  ylim(c(-883500, 952500))

## show all predictions together
ggarrange(herbMap_as, herbMap_ds, herbCompareMap, 
          treeMap_as, treeMap_ds, treeCompareMap, 
          shrubMap_as, shrubMap_ds, shrubCompareMap, 
          bareGroundMap_as, bareGroundMap_ds, bareGroundCompareMap, 
          ncol = 3, nrow = 4) %>% 
  annotate_figure(fig.lab = "Comparing relativized predictions from current models to previous SOILWAT data", fig.lab.size = 20)
```

# Now, save predicted data 
```{r}
# level 1 cover data 
# shrub cover predicted CONUS-wide with contemporary dayMet data
names(contempScaledPreds_maps[[1]]$rast) <- "shrubCover"
# bare ground cover predicted CONUS-wide with contemporary dayMet data
names(contempScaledPreds_maps[[2]]$rast) <- "bareGroundCover"

# level 2 cover data
# C3 graminoid cover
names(contemp_cover2_ScaledPreds_maps[[1]]$rast) <- "C3GramCover"
# C4 graminoid cover
names(contemp_cover2_ScaledPreds_maps[[2]]$rast) <- "C4GramCover"
# forb cover
names(contemp_cover2_ScaledPreds_maps[[3]]$rast) <- "forbCover"
# broad leaved tree cover
names(contemp_cover2_ScaledPreds_maps[[4]]$rast) <- "broadLeavedTreeCover"
# needle leaved cover 
names(contemp_cover2_ScaledPreds_maps[[5]]$rast) <- "needleLeavedTreeCover"

predictedCover_contempData <- c(contempScaledPreds_maps[[1]]$rast, 
                                contempScaledPreds_maps[[2]]$rast,
                                contemp_cover2_ScaledPreds_maps[[1]]$rast, 
                                contemp_cover2_ScaledPreds_maps[[2]]$rast, 
                                contemp_cover2_ScaledPreds_maps[[3]]$rast, 
                                contemp_cover2_ScaledPreds_maps[[4]]$rast, 
                                contemp_cover2_ScaledPreds_maps[[5]]$rast)

terra::writeRaster(x = predictedCover_contempData, 
                   filename = "../../../Data_processed/CoverData/ModelPredictionData/ModelPreds_ContempClimateData_dayMetScale.tif", 
                   overwrite = TRUE)
```

